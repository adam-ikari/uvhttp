# UVHTTP å†…å­˜åˆ†é…å™¨æ€§èƒ½æµ‹è¯• Makefile

CC = gcc
CFLAGS = -std=c11 -Wall -Wextra -O2 -DNDEBUG
LDFLAGS = -lm

# æµ‹è¯•é…ç½®
TEST_FLAGS = -DUVHTTP_TEST_MODE=0  # ç”Ÿäº§æ¨¡å¼æµ‹è¯•æ€§èƒ½

# åŒ…å«ç›®å½•
INCLUDES = -I../include

# æºæ–‡ä»¶
TEST_SOURCES = test_allocator_performance.c

# ç›®æ ‡æ–‡ä»¶
TARGET = test_allocator_performance

# é»˜è®¤ç›®æ ‡
all: $(TARGET)

# ç¼–è¯‘æ€§èƒ½æµ‹è¯•
$(TARGET): $(TEST_SOURCES)
	$(CC) $(CFLAGS) $(TEST_FLAGS) $(INCLUDES) -o $@ $^ $(LDFLAGS)

# è¿è¡Œæ€§èƒ½æµ‹è¯•
test: $(TARGET)
	./$(TARGET)

# æµ‹è¯•ä¸åŒåˆ†é…å™¨ç±»å‹
test-default: CFLAGS += -DUVHTTP_ALLOCATOR_TYPE=0
test-default: clean $(TARGET)
	@echo "ğŸ”§ æµ‹è¯•ç³»ç»Ÿé»˜è®¤åˆ†é…å™¨..."
	./$(TARGET)

test-mimalloc: CFLAGS += -DUVHTTP_ALLOCATOR_TYPE=1
test-mimalloc: clean $(TARGET)
	@echo "ğŸš€ æµ‹è¯• mimalloc åˆ†é…å™¨..."
	./$(TARGET)

test-custom: CFLAGS += -DUVHTTP_ALLOCATOR_TYPE=2
test-custom: clean $(TARGET)
	@echo "ğŸ› ï¸ æµ‹è¯•è‡ªå®šä¹‰åˆ†é…å™¨..."
	./$(TARGET)

# æ¯”è¾ƒä¸åŒåˆ†é…å™¨æ€§èƒ½
compare: test-default test-mimalloc
	@echo "ğŸ“Š æ€§èƒ½æ¯”è¾ƒå®Œæˆ"

# å†…å­˜æ£€æŸ¥ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰
memcheck: CFLAGS = -std=c11 -Wall -Wextra -g -O0 -DUVHTTP_TEST_MODE=1
memcheck: clean $(TARGET)
	valgrind --tool=massif ./$(TARGET)

# æ€§èƒ½åˆ†æ
profile: CFLAGS += -pg
profile: clean $(TARGET)
	./$(TARGET)
	gprof $(TARGET) gmon.out > profile_report.txt
	@echo "ğŸ“ˆ æ€§èƒ½åˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ: profile_report.txt"

# ç¼–è¯‘æ—¶ä¼˜åŒ–æ£€æŸ¥
optimization-check:
	@echo "ğŸ” æ£€æŸ¥ç¼–è¯‘æ—¶ä¼˜åŒ–..."
	$(CC) $(CFLAGS) $(TEST_FLAGS) $(INCLUDES) -S test_allocator_performance.c -o - | grep -E "(call|jmp)" | wc -l
	@echo "ğŸ“Š å‡½æ•°è°ƒç”¨æ•°é‡ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰"

# æ¸…ç†
clean:
	rm -f $(TARGET) gmon.out profile_report.txt

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "UVHTTP å†…å­˜åˆ†é…å™¨æ€§èƒ½æµ‹è¯•"
	@echo "==========================="
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all           - ç¼–è¯‘æ€§èƒ½æµ‹è¯•"
	@echo "  test          - è¿è¡Œæ€§èƒ½æµ‹è¯•"
	@echo "  test-default  - æµ‹è¯•ç³»ç»Ÿé»˜è®¤åˆ†é…å™¨"
	@echo "  test-mimalloc - æµ‹è¯• mimalloc åˆ†é…å™¨"
	@echo "  test-custom   - æµ‹è¯•è‡ªå®šä¹‰åˆ†é…å™¨"
	@echo "  compare       - æ¯”è¾ƒä¸åŒåˆ†é…å™¨æ€§èƒ½"
	@echo "  memcheck      - å†…å­˜ä½¿ç”¨åˆ†æ"
	@echo "  profile       - æ€§èƒ½åˆ†æ"
	@echo "  optimization-check - æ£€æŸ¥ç¼–è¯‘ä¼˜åŒ–"
	@echo "  clean         - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  help          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ç¤ºä¾‹ç”¨æ³•:"
	@echo "  make test-default    # æµ‹è¯•ç³»ç»Ÿåˆ†é…å™¨"
	@echo "  make compare         # æ¯”è¾ƒæ€§èƒ½"
	@echo "  make memcheck        # å†…å­˜åˆ†æ"

.PHONY: all test test-default test-mimalloc test-custom compare memcheck profile optimization-check clean help