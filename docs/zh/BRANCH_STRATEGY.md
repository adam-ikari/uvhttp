# 分支策略 (Branch Strategy)

## 分支概述

UVHTTP 项目采用简化的分支策略，确保清晰的开发流程和发布管理。

## 主要分支

### main
- **用途**: 生产代码，稳定版本
- **保护规则**:
  - 必须通过 PR 合并
  - 必须通过 CI/CD 检查
  - 至少 1 人审查
- **来源**: 从 `develop` 分支合并
- **状态**: 始终可部署

### develop
- **用途**: 开发分支，集成最新功能
- **保护规则**:
  - 必须通过 PR 合并
  - 必须通过 CI/CD 检查
  - 至少 1 人审查
- **来源**: 从功能分支合并
- **状态**: 相对稳定，但可能包含未发布的功能

### pre-release
- **用途**: 预发布准备分支
- **保护规则**:
  - 必须通过 PR 合并
  - 必须通过完整 CI/CD 检查
  - 至少 1 人审查
- **来源**: 从 `main` 分支合并
- **状态**: 发布准备

### release
- **用途**: 发布分支，正式发布版本
- **保护规则**:
  - 必须通过 PR 合并
  - 必须通过完整 CI/CD 检查
  - 至少 1 人审查
- **来源**: 从 `pre-release` 分支合并
- **状态**: 正式发布到生产环境

## 分支流程

```
develop → main → pre-release → release
   ↓        ↓         ↓            ↓
 开发中   预发布测试  发布准备     生产环境
```

### 1. 功能开发
- 从 `develop` 创建功能分支
- 命名规范: `feature/功能名称` 或 `fix/问题描述`
- 完成后通过 PR 合并到 `develop`

### 2. 发布流程
1. **develop → main**: 预发布测试和验证
2. **main → pre-release**: 发布准备
3. **pre-release → release**: 正式发布到生产环境

### 3. 紧急修复
- 从 `main` 创建修复分支
- 命名规范: `hotfix/问题描述`
- 修复后合并到 `main` 和 `develop`

## CI/CD 触发

### ci-pr.yml
- **触发**: PR 到 `main` 或 `develop`
- **用途**: 快速验证（20 分钟）
- **检查**: 构建、单元测试、代码质量、性能回归检测

### ci-push.yml
- **触发**: Push 到任何分支
- **用途**: 完整验证（45 分钟）
- **检查**: 多平台构建、完整测试、安全扫描、性能测试

### ci-nightly.yml
- **触发**: 每天运行
- **用途**: 深度测试（120 分钟）
- **检查**: 代码覆盖率、内存泄漏、压力测试、完整性能测试

### ci-release.yml
- **触发**: Push 到 `release` 分支
- **用途**: 发布构建（60 分钟）
- **检查**: 发布包构建、签名、性能基线更新

### security-issue-creator.yml
- **触发**: 安全扫描工作流完成
- **用途**: 自动创建安全 Issue
- **检查**: 检测安全问题并创建 Issue

## 安全 Issue 自动创建

当 CI/CD 检测到安全问题时，会自动创建 Issue：

### 触发条件
- cppcheck 检测到安全问题
- clang-tidy 检测到安全问题
- CodeQL 检测到安全漏洞

### Issue 内容
- 问题数量和详情
- 触发的分支和提交
- 工作流运行链接
- 修复建议

### Issue 标签
- `security`: 安全相关
- `automated`: 自动创建
- `bug`: 缺陷

## Dependabot 分支

Dependabot 自动创建的分支用于依赖更新：

- **命名**: `dependabot/包管理器/包名`
- **状态**: 自动创建 PR
- **策略**: 只更新到稳定版本（`versioning-strategy: increase`）
- **合并**: 需要人工审查后合并

## 分支清理

### 自动清理
- 已合并的 PR 分支在合并后自动删除
- Dependabot 分支在 PR 关闭后自动删除

### 手动清理
定期清理已合并的分支：

```bash
# 查看已合并的分支
git branch --merged

# 删除已合并的本地分支
git branch -d 分支名

# 删除远程分支
git push origin --delete 分支名
```

### 保留分支
以下分支永远不会删除：
- `main`
- `develop`
- `pre-release`
- `release`
- 任何活跃的 PR 分支

## 最佳实践

1. **保持分支简短**: 功能分支应该快速完成并合并
2. **频繁同步**: 定期从上游分支同步最新代码
3. **清晰的提交信息**: 使用规范的提交信息格式
4. **及时合并**: 不要让 PR 开放太长时间
5. **删除无用分支**: 及时清理已合并的分支
6. **保护主分支**: 确保 `main` 分支始终稳定
7. **使用 CI/CD**: 所有更改必须通过 CI/CD 检查
8. **代码审查**: 所有合并都需要至少 1 人审查

## 常见问题

### Q: 如何创建新功能？
A: 从 `develop` 创建功能分支，开发完成后通过 PR 合并回 `develop`。

### Q: 如何修复紧急问题？
A: 从 `main` 创建 `hotfix` 分支，修复后合并到 `main` 和 `develop`。

### Q: 什么时候合并到 `main`？
A: 只有在 `release` 分支准备好发布时才合并到 `main`。

### Q: Dependabot 分支可以删除吗？
A: 不可以，这些是活跃的 PR，需要人工审查后合并或关闭。

### Q: 如何查看当前分支状态？
A: 使用 `git branch -a` 查看所有分支，`git status` 查看当前状态。

## 相关文档

- [CI/CD 架构设计](./CI_CD_REDESIGN.md)
- [开发者指南](./dev/DEVELOPER_GUIDE.md)
- [发布流程](./LIFECYCLE_DESIGN.md)