\hypertarget{uvhttp__response_8h_source}{}\doxysection{uvhttp\+\_\+response.\+h}
\label{uvhttp__response_8h_source}\index{include/uvhttp\_response.h@{include/uvhttp\_response.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#ifndef UVHTTP\_RESPONSE\_H}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#define UVHTTP\_RESPONSE\_H}}
\DoxyCodeLine{3 }
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include "{}uvhttp\_common.h"{}}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#include "{}uvhttp\_error.h"{}}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#include "{}uvhttp\_platform.h"{}}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <assert.h>}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <stddef.h>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <stdlib.h>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <string.h>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <uv.h>}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{preprocessor}{\#ifdef \_\_cplusplus}}
\DoxyCodeLine{15 \textcolor{keyword}{extern} \textcolor{stringliteral}{"{}C"{}} \{}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{comment}{// 前向声明}}
\DoxyCodeLine{19 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }\mbox{\hyperlink{structuvhttp__connection}{uvhttp\_connection}} \mbox{\hyperlink{structuvhttp__connection}{uvhttp\_connection\_t}};}
\DoxyCodeLine{20 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response}} \mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}};}
\DoxyCodeLine{21 }
\DoxyCodeLine{22 \textcolor{preprocessor}{\#define MAX\_RESPONSE\_BODY\_LEN (1024 * 1024)  }\textcolor{comment}{// 1MB}}
\DoxyCodeLine{23 }
\DoxyCodeLine{24 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }\{}
\DoxyCodeLine{25     uv\_write\_t write\_req;}
\DoxyCodeLine{26     \textcolor{keywordtype}{size\_t} length;}
\DoxyCodeLine{27     \mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response;}
\DoxyCodeLine{28     \textcolor{keywordtype}{char} data[1]; \textcolor{comment}{/* 数据缓冲区，至少1字节 */}}
\DoxyCodeLine{29 \} \mbox{\hyperlink{structuvhttp__write__data__t}{uvhttp\_write\_data\_t}};}
\DoxyCodeLine{30 }
\DoxyCodeLine{31 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }\{}
\DoxyCodeLine{32     \textcolor{keywordtype}{char}* data;}
\DoxyCodeLine{33     \textcolor{keywordtype}{size\_t} length;}
\DoxyCodeLine{34     \mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response;}
\DoxyCodeLine{35     \mbox{\hyperlink{structuvhttp__connection}{uvhttp\_connection\_t}}* connection;}
\DoxyCodeLine{36     \textcolor{keywordtype}{size\_t} offset;}
\DoxyCodeLine{37 \} \mbox{\hyperlink{structuvhttp__tls__write__data__t}{uvhttp\_tls\_write\_data\_t}};}
\DoxyCodeLine{38 }
\DoxyCodeLine{39 \textcolor{keyword}{struct }\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response}} \{}
\DoxyCodeLine{40     \textcolor{comment}{/* ========== 缓存行1（0-\/63字节）：热路径字段 -\/ 最频繁访问 ========== */}}
\DoxyCodeLine{41     \textcolor{comment}{/* 在响应构建、发送过程中频繁访问 */}}
\DoxyCodeLine{42     \textcolor{keywordtype}{int} status\_code;     \textcolor{comment}{/* 4 字节 -\/ HTTP 状态码 */}}
\DoxyCodeLine{43     \textcolor{keywordtype}{int} headers\_sent;    \textcolor{comment}{/* 4 字节 -\/ 头部是否已发送 */}}
\DoxyCodeLine{44     \textcolor{keywordtype}{int} sent;            \textcolor{comment}{/* 4 字节 -\/ 响应是否已发送 */}}
\DoxyCodeLine{45     \textcolor{keywordtype}{int} finished;        \textcolor{comment}{/* 4 字节 -\/ 响应是否完成 */}}
\DoxyCodeLine{46     \textcolor{keywordtype}{int} keepalive;       \textcolor{comment}{/* 4 字节 -\/ 是否保持连接 */}}
\DoxyCodeLine{47     \textcolor{keywordtype}{int} compress;        \textcolor{comment}{/* 4 字节 -\/ 是否启用压缩 */}}
\DoxyCodeLine{48     \textcolor{keywordtype}{int} cache\_ttl;       \textcolor{comment}{/* 4 字节 -\/ 缓存 TTL（秒） */}}
\DoxyCodeLine{49     \textcolor{keywordtype}{int} \_padding1;       \textcolor{comment}{/* 4 字节 -\/ 填充到32字节 */}}
\DoxyCodeLine{50     \textcolor{keywordtype}{size\_t} header\_count; \textcolor{comment}{/* 8 字节 -\/ header 数量 */}}
\DoxyCodeLine{51     \textcolor{keywordtype}{size\_t} body\_length;  \textcolor{comment}{/* 8 字节 -\/ body 长度 */}}
\DoxyCodeLine{52     uv\_tcp\_t* client;    \textcolor{comment}{/* 8 字节 -\/ TCP 客户端句柄 */}}
\DoxyCodeLine{53     \textcolor{keywordtype}{char}* body;          \textcolor{comment}{/* 8 字节 -\/ 响应体 */}}
\DoxyCodeLine{54     \textcolor{comment}{/* 缓存行1总计：64字节 */}}
\DoxyCodeLine{55 }
\DoxyCodeLine{56     \textcolor{comment}{/* ========== 缓存行2（64-\/127字节）：指针和计数器字段 -\/ 次频繁访问}}
\DoxyCodeLine{57 \textcolor{comment}{     * ========== */}}
\DoxyCodeLine{58     \textcolor{comment}{/* 在响应构建、缓存管理中频繁访问 */}}
\DoxyCodeLine{59     time\_t cache\_expires;           \textcolor{comment}{/* 8 字节 -\/ 缓存过期时间 */}}
\DoxyCodeLine{60     \mbox{\hyperlink{structuvhttp__header__t}{uvhttp\_header\_t}}* headers\_extra; \textcolor{comment}{/* 8 字节 -\/ 额外 headers（动态扩容） */}}
\DoxyCodeLine{61     \textcolor{keywordtype}{size\_t} headers\_capacity;        \textcolor{comment}{/* 8 字节 -\/ headers 总容量 */}}
\DoxyCodeLine{62     \textcolor{keywordtype}{int} \_padding2[10];              \textcolor{comment}{/* 40字节 -\/ 填充到64字节 */}}
\DoxyCodeLine{63     \textcolor{comment}{/* 缓存行2总计：64字节 */}}
\DoxyCodeLine{64 }
\DoxyCodeLine{65     \textcolor{comment}{/* ========== 缓存行3+（128+字节）：Headers 数组 ========== */}}
\DoxyCodeLine{66     \textcolor{comment}{/* 放在最后，避免影响热路径字段的缓存局部性 */}}
\DoxyCodeLine{67     \textcolor{comment}{/* Headers -\/ 混合分配：内联 + 动态扩容（优化内存局部性） */}}
\DoxyCodeLine{68     \mbox{\hyperlink{structuvhttp__header__t}{uvhttp\_header\_t}}}
\DoxyCodeLine{69         headers[\mbox{\hyperlink{uvhttp__constants_8h_abab5c4bf7dbfb9cc7a120f4b52c923fa}{UVHTTP\_INLINE\_HEADERS\_CAPACITY}}]; \textcolor{comment}{/* 内联，减少动态分配 */}}
\DoxyCodeLine{70 \};}
\DoxyCodeLine{71 }
\DoxyCodeLine{72 \textcolor{comment}{/* ========== 内存布局验证静态断言 ========== */}}
\DoxyCodeLine{73 }
\DoxyCodeLine{74 \textcolor{comment}{/* 验证指针对齐（平台自适应） */}}
\DoxyCodeLine{75 UVHTTP\_CHECK\_ALIGNMENT(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}, client, UVHTTP\_POINTER\_ALIGNMENT);}
\DoxyCodeLine{76 UVHTTP\_CHECK\_ALIGNMENT(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}, body, UVHTTP\_POINTER\_ALIGNMENT);}
\DoxyCodeLine{77 }
\DoxyCodeLine{78 \textcolor{comment}{/* 验证size\_t对齐（平台自适应） */}}
\DoxyCodeLine{79 UVHTTP\_CHECK\_ALIGNMENT(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}, header\_count,}
\DoxyCodeLine{80                        UVHTTP\_SIZE\_T\_ALIGNMENT);}
\DoxyCodeLine{81 UVHTTP\_CHECK\_ALIGNMENT(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}, body\_length, UVHTTP\_SIZE\_T\_ALIGNMENT);}
\DoxyCodeLine{82 UVHTTP\_CHECK\_ALIGNMENT(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}, cache\_expires,}
\DoxyCodeLine{83                        UVHTTP\_SIZE\_T\_ALIGNMENT);}
\DoxyCodeLine{84 }
\DoxyCodeLine{85 \textcolor{comment}{/* 验证大型缓冲区在结构体末尾 */}}
\DoxyCodeLine{86 UVHTTP\_STATIC\_ASSERT(offsetof(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}, headers) >= 64,}
\DoxyCodeLine{87                      \textcolor{stringliteral}{"{}headers array should be after first 64 bytes"{}});}
\DoxyCodeLine{88 }
\DoxyCodeLine{89 \textcolor{comment}{/* ============ 核心 API 函数 ============ */}}
\DoxyCodeLine{90 uvhttp\_error\_t uvhttp\_response\_init(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response, \textcolor{keywordtype}{void}* client);}
\DoxyCodeLine{91 uvhttp\_error\_t uvhttp\_response\_set\_status(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response,}
\DoxyCodeLine{92                                           \textcolor{keywordtype}{int} status\_code);}
\DoxyCodeLine{93 uvhttp\_error\_t uvhttp\_response\_set\_header(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response,}
\DoxyCodeLine{94                                           \textcolor{keyword}{const} \textcolor{keywordtype}{char}* name, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* value);}
\DoxyCodeLine{95 uvhttp\_error\_t uvhttp\_response\_set\_body(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response,}
\DoxyCodeLine{96                                         \textcolor{keyword}{const} \textcolor{keywordtype}{char}* body, \textcolor{keywordtype}{size\_t} length);}
\DoxyCodeLine{97 }
\DoxyCodeLine{98 \textcolor{comment}{/* ============ 重构后的函数：分离纯函数和副作用 ============ */}}
\DoxyCodeLine{99 }
\DoxyCodeLine{100 \textcolor{comment}{/* 纯函数：构建HTTP响应数据，无副作用，易于测试}}
\DoxyCodeLine{101 \textcolor{comment}{ * 调用者负责释放返回的 *out\_data 内存}}
\DoxyCodeLine{102 \textcolor{comment}{ */}}
\DoxyCodeLine{103 uvhttp\_error\_t uvhttp\_response\_build\_data(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response,}
\DoxyCodeLine{104                                           \textcolor{keywordtype}{char}** out\_data, \textcolor{keywordtype}{size\_t}* out\_length);}
\DoxyCodeLine{105 }
\DoxyCodeLine{106 \textcolor{comment}{/* 副作用函数：发送原始数据，包含网络I/O */}}
\DoxyCodeLine{107 uvhttp\_error\_t uvhttp\_response\_send\_raw(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* data, \textcolor{keywordtype}{size\_t} length,}
\DoxyCodeLine{108                                         \textcolor{keywordtype}{void}* client,}
\DoxyCodeLine{109                                         \mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response);}
\DoxyCodeLine{110 }
\DoxyCodeLine{111 \textcolor{comment}{/* 响应发送函数 */}}
\DoxyCodeLine{112 uvhttp\_error\_t uvhttp\_response\_send(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response);}
\DoxyCodeLine{113 }
\DoxyCodeLine{114 \textcolor{comment}{/* ============ 原有函数 ============ */}}
\DoxyCodeLine{115 \textcolor{keywordtype}{void} uvhttp\_response\_cleanup(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response);}
\DoxyCodeLine{116 \textcolor{keywordtype}{void} uvhttp\_response\_free(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response);}
\DoxyCodeLine{117 }
\DoxyCodeLine{118 \textcolor{comment}{/* ========== Headers 操作 API ========== */}}
\DoxyCodeLine{119 }
\DoxyCodeLine{120 \textcolor{comment}{/* 获取 header 数量 */}}
\DoxyCodeLine{121 \textcolor{keywordtype}{size\_t} uvhttp\_response\_get\_header\_count(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response);}
\DoxyCodeLine{122 }
\DoxyCodeLine{123 \textcolor{comment}{/* 获取指定索引的 header（内部使用） */}}
\DoxyCodeLine{124 \mbox{\hyperlink{structuvhttp__header__t}{uvhttp\_header\_t}}* uvhttp\_response\_get\_header\_at(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response,}
\DoxyCodeLine{125                                                \textcolor{keywordtype}{size\_t} index);}
\DoxyCodeLine{126 }
\DoxyCodeLine{127 \textcolor{comment}{/* 遍历所有 headers */}}
\DoxyCodeLine{128 \textcolor{keyword}{typedef} void (*uvhttp\_header\_callback\_t)(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* name, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* value,}
\DoxyCodeLine{129                                          \textcolor{keywordtype}{void}* user\_data);}
\DoxyCodeLine{130 \textcolor{keywordtype}{void} uvhttp\_response\_foreach\_header(\mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response,}
\DoxyCodeLine{131                                     uvhttp\_header\_callback\_t callback,}
\DoxyCodeLine{132                                     \textcolor{keywordtype}{void}* user\_data);}
\DoxyCodeLine{133 }
\DoxyCodeLine{134 \textcolor{preprocessor}{\#ifdef \_\_cplusplus}}
\DoxyCodeLine{135 \}}
\DoxyCodeLine{136 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{137 }
\DoxyCodeLine{138 \textcolor{preprocessor}{\#endif }\textcolor{comment}{/* UVHTTP\_RESPONSE\_H */}\textcolor{preprocessor}{}}

\end{DoxyCode}
