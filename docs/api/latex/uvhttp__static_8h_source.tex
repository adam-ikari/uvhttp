\hypertarget{uvhttp__static_8h_source}{}\doxysection{uvhttp\+\_\+static.\+h}
\label{uvhttp__static_8h_source}\index{include/uvhttp\_static.h@{include/uvhttp\_static.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/* UVHTTP 静态文件服务模块 -\/ 统一版本，支持可选LRU缓存 */}}
\DoxyCodeLine{2 }
\DoxyCodeLine{3 \textcolor{preprocessor}{\#ifndef UVHTTP\_STATIC\_H}}
\DoxyCodeLine{4 \textcolor{preprocessor}{\#define UVHTTP\_STATIC\_H}}
\DoxyCodeLine{5 }
\DoxyCodeLine{6 \textcolor{preprocessor}{\#if UVHTTP\_FEATURE\_STATIC\_FILES}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#    include "{}\mbox{\hyperlink{uvhttp__constants_8h}{uvhttp\_constants.h}}"{}}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#    include "{}uvhttp\_error.h"{}}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#    include "{}uvhttp\_middleware.h"{}}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{preprocessor}{\#    include <stddef.h>}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#    include <time.h>}}
\DoxyCodeLine{14 }
\DoxyCodeLine{15 \textcolor{comment}{/* LRU缓存条件编译支持 */}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#    if UVHTTP\_FEATURE\_LRU\_CACHE}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#        include "{}uvhttp\_lru\_cache.h"{}}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#    endif}}
\DoxyCodeLine{19 }
\DoxyCodeLine{20 \textcolor{comment}{/* 前向声明 */}}
\DoxyCodeLine{21 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }cache\_manager cache\_manager\_t;}
\DoxyCodeLine{22 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }cache\_entry cache\_entry\_t;}
\DoxyCodeLine{23 }
\DoxyCodeLine{24 \textcolor{preprocessor}{\#    ifdef \_\_cplusplus}}
\DoxyCodeLine{25 \textcolor{keyword}{extern} \textcolor{stringliteral}{"{}C"{}} \{}
\DoxyCodeLine{26 \textcolor{preprocessor}{\#    endif}}
\DoxyCodeLine{27 }
\DoxyCodeLine{28 \textcolor{comment}{/* 静态文件配置结构 -\/ CPU 缓存优化布局 */}}
\DoxyCodeLine{29 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }uvhttp\_static\_config \{}
\DoxyCodeLine{30     \textcolor{comment}{/* 8字节对齐字段 -\/ 热路径 */}}
\DoxyCodeLine{31     \textcolor{keywordtype}{size\_t} max\_cache\_size;      \textcolor{comment}{/* 最大缓存大小（字节） */}}
\DoxyCodeLine{32     \textcolor{keywordtype}{size\_t} sendfile\_chunk\_size; \textcolor{comment}{/* sendfile 分块大小（字节） */}}
\DoxyCodeLine{33 }
\DoxyCodeLine{34     \textcolor{comment}{/* 4字节对齐字段 -\/ 中等访问频率 */}}
\DoxyCodeLine{35     \textcolor{keywordtype}{int} cache\_ttl;                \textcolor{comment}{/* 缓存TTL（秒） */}}
\DoxyCodeLine{36     \textcolor{keywordtype}{int} max\_cache\_entries;        \textcolor{comment}{/* 最大缓存条目数 */}}
\DoxyCodeLine{37     \textcolor{keywordtype}{int} sendfile\_timeout\_ms;      \textcolor{comment}{/* sendfile 超时时间（毫秒） */}}
\DoxyCodeLine{38     \textcolor{keywordtype}{int} sendfile\_max\_retry;       \textcolor{comment}{/* sendfile 最大重试次数 */}}
\DoxyCodeLine{39     \textcolor{keywordtype}{int} enable\_directory\_listing; \textcolor{comment}{/* 是否启用目录列表 */}}
\DoxyCodeLine{40     \textcolor{keywordtype}{int} enable\_etag;              \textcolor{comment}{/* 是否启用ETag */}}
\DoxyCodeLine{41     \textcolor{keywordtype}{int} enable\_last\_modified;     \textcolor{comment}{/* 是否启用Last-\/Modified */}}
\DoxyCodeLine{42     \textcolor{keywordtype}{int} enable\_sendfile;          \textcolor{comment}{/* 是否启用 sendfile 零拷贝优化 */}}
\DoxyCodeLine{43 }
\DoxyCodeLine{44     \textcolor{comment}{/* 字符串字段 -\/ 冷路径 */}}
\DoxyCodeLine{45     \textcolor{keywordtype}{char} root\_directory[\mbox{\hyperlink{uvhttp__constants_8h_aa8bbae5e9797276818c20d6fff47168b}{UVHTTP\_MAX\_FILE\_PATH\_SIZE}}];    \textcolor{comment}{/* 根目录路径 */}}
\DoxyCodeLine{46     \textcolor{keywordtype}{char} index\_file[UVHTTP\_MAX\_PATH\_SIZE];             \textcolor{comment}{/* 默认索引文件 */}}
\DoxyCodeLine{47     \textcolor{keywordtype}{char} custom\_headers[UVHTTP\_MAX\_HEADER\_VALUE\_SIZE]; \textcolor{comment}{/* 自定义响应头 */}}
\DoxyCodeLine{48 \} uvhttp\_static\_config\_t;}
\DoxyCodeLine{49 }
\DoxyCodeLine{50 \textcolor{comment}{/* 静态文件服务上下文 */}}
\DoxyCodeLine{51 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }uvhttp\_static\_context \{}
\DoxyCodeLine{52     uvhttp\_static\_config\_t config; \textcolor{comment}{/* 配置 */}}
\DoxyCodeLine{53     cache\_manager\_t* cache;        \textcolor{comment}{/* LRU缓存管理器 */}}
\DoxyCodeLine{54 \} uvhttp\_static\_context\_t;}
\DoxyCodeLine{55 }
\DoxyCodeLine{56 \textcolor{comment}{/* MIME类型映射条目 */}}
\DoxyCodeLine{57 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }uvhttp\_mime\_mapping \{}
\DoxyCodeLine{58     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* extension; \textcolor{comment}{/* 文件扩展名 */}}
\DoxyCodeLine{59     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* mime\_type; \textcolor{comment}{/* MIME类型 */}}
\DoxyCodeLine{60 \} uvhttp\_mime\_mapping\_t;}
\DoxyCodeLine{61 }
\DoxyCodeLine{69 uvhttp\_error\_t uvhttp\_static\_create(\textcolor{keyword}{const} uvhttp\_static\_config\_t* config,}
\DoxyCodeLine{70                                     uvhttp\_static\_context\_t** context);}
\DoxyCodeLine{80 uvhttp\_error\_t uvhttp\_static\_set\_sendfile\_config(uvhttp\_static\_context\_t* ctx,}
\DoxyCodeLine{81                                                  \textcolor{keywordtype}{int} timeout\_ms, \textcolor{keywordtype}{int} max\_retry,}
\DoxyCodeLine{82                                                  \textcolor{keywordtype}{size\_t} chunk\_size);}
\DoxyCodeLine{83 }
\DoxyCodeLine{89 \textcolor{keywordtype}{void} uvhttp\_static\_free(uvhttp\_static\_context\_t* ctx);}
\DoxyCodeLine{90 }
\DoxyCodeLine{99 uvhttp\_result\_t uvhttp\_static\_handle\_request(uvhttp\_static\_context\_t* ctx,}
\DoxyCodeLine{100                                              \textcolor{keywordtype}{void}* request, \textcolor{keywordtype}{void}* response);}
\DoxyCodeLine{101 }
\DoxyCodeLine{114 uvhttp\_result\_t uvhttp\_static\_sendfile(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* file\_path, \textcolor{keywordtype}{void}* response);}
\DoxyCodeLine{115 }
\DoxyCodeLine{124 uvhttp\_result\_t uvhttp\_static\_get\_mime\_type(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* file\_path,}
\DoxyCodeLine{125                                             \textcolor{keywordtype}{char}* mime\_type,}
\DoxyCodeLine{126                                             \textcolor{keywordtype}{size\_t} buffer\_size);}
\DoxyCodeLine{127 }
\DoxyCodeLine{133 \textcolor{keywordtype}{void} uvhttp\_static\_clear\_cache(uvhttp\_static\_context\_t* ctx);}
\DoxyCodeLine{134 }
\DoxyCodeLine{142 uvhttp\_result\_t uvhttp\_static\_prewarm\_cache(uvhttp\_static\_context\_t* ctx,}
\DoxyCodeLine{143                                             \textcolor{keyword}{const} \textcolor{keywordtype}{char}* file\_path);}
\DoxyCodeLine{144 }
\DoxyCodeLine{153 \textcolor{keywordtype}{int} uvhttp\_static\_prewarm\_directory(uvhttp\_static\_context\_t* ctx,}
\DoxyCodeLine{154                                     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* dir\_path, \textcolor{keywordtype}{int} max\_files);}
\DoxyCodeLine{155 }
\DoxyCodeLine{165 \textcolor{keywordtype}{int} uvhttp\_static\_resolve\_safe\_path(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* root\_dir, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* file\_path,}
\DoxyCodeLine{166                                     \textcolor{keywordtype}{char}* resolved\_path, \textcolor{keywordtype}{size\_t} buffer\_size);}
\DoxyCodeLine{167 }
\DoxyCodeLine{178 uvhttp\_result\_t uvhttp\_static\_generate\_etag(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* file\_path,}
\DoxyCodeLine{179                                             time\_t last\_modified,}
\DoxyCodeLine{180                                             \textcolor{keywordtype}{size\_t} file\_size, \textcolor{keywordtype}{char}* etag,}
\DoxyCodeLine{181                                             \textcolor{keywordtype}{size\_t} buffer\_size);}
\DoxyCodeLine{182 }
\DoxyCodeLine{191 \textcolor{keywordtype}{int} uvhttp\_static\_check\_conditional\_request(\textcolor{keywordtype}{void}* request, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* etag,}
\DoxyCodeLine{192                                             time\_t last\_modified);}
\DoxyCodeLine{193 }
\DoxyCodeLine{204 uvhttp\_result\_t uvhttp\_static\_set\_response\_headers(\textcolor{keywordtype}{void}* response,}
\DoxyCodeLine{205                                                    \textcolor{keyword}{const} \textcolor{keywordtype}{char}* file\_path,}
\DoxyCodeLine{206                                                    \textcolor{keywordtype}{size\_t} file\_size,}
\DoxyCodeLine{207                                                    time\_t last\_modified,}
\DoxyCodeLine{208                                                    \textcolor{keyword}{const} \textcolor{keywordtype}{char}* etag);}
\DoxyCodeLine{209 }
\DoxyCodeLine{220 \textcolor{keywordtype}{void} uvhttp\_static\_get\_cache\_stats(uvhttp\_static\_context\_t* ctx,}
\DoxyCodeLine{221                                    \textcolor{keywordtype}{size\_t}* total\_memory\_usage, \textcolor{keywordtype}{int}* entry\_count,}
\DoxyCodeLine{222                                    \textcolor{keywordtype}{int}* hit\_count, \textcolor{keywordtype}{int}* miss\_count,}
\DoxyCodeLine{223                                    \textcolor{keywordtype}{int}* eviction\_count);}
\DoxyCodeLine{224 }
\DoxyCodeLine{231 \textcolor{keywordtype}{double} uvhttp\_static\_get\_cache\_hit\_rate(uvhttp\_static\_context\_t* ctx);}
\DoxyCodeLine{232 }
\DoxyCodeLine{239 \textcolor{keywordtype}{int} uvhttp\_static\_cleanup\_expired\_cache(uvhttp\_static\_context\_t* ctx);}
\DoxyCodeLine{240 }
\DoxyCodeLine{250 uvhttp\_result\_t uvhttp\_static\_enable\_cache(uvhttp\_static\_context\_t* ctx,}
\DoxyCodeLine{251                                            \textcolor{keywordtype}{size\_t} max\_memory, \textcolor{keywordtype}{int} max\_entries,}
\DoxyCodeLine{252                                            \textcolor{keywordtype}{int} ttl);}
\DoxyCodeLine{253 }
\DoxyCodeLine{259 \textcolor{keywordtype}{void} uvhttp\_static\_disable\_cache(uvhttp\_static\_context\_t* ctx);}
\DoxyCodeLine{260 }
\DoxyCodeLine{261 \textcolor{comment}{/* ========== 静态文件中间件接口 ========== */}}
\DoxyCodeLine{262 }
\DoxyCodeLine{263 \textcolor{preprocessor}{\#    ifdef \_\_cplusplus}}
\DoxyCodeLine{264 \}}
\DoxyCodeLine{265 \textcolor{preprocessor}{\#    endif}}
\DoxyCodeLine{266 }
\DoxyCodeLine{267 \textcolor{preprocessor}{\#endif }\textcolor{comment}{/* UVHTTP\_FEATURE\_STATIC\_FILES */}\textcolor{preprocessor}{}}
\DoxyCodeLine{268 }
\DoxyCodeLine{269 \textcolor{preprocessor}{\#endif }\textcolor{comment}{/* UVHTTP\_STATIC\_H */}\textcolor{preprocessor}{}}

\end{DoxyCode}
