\hypertarget{uvhttp__middleware_8h_source}{}\doxysection{uvhttp\+\_\+middleware.\+h}
\label{uvhttp__middleware_8h_source}\index{include/uvhttp\_middleware.h@{include/uvhttp\_middleware.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{ * UVHTTP 中间件系统 -\/ 编译期配置版本}}
\DoxyCodeLine{3 \textcolor{comment}{ *}}
\DoxyCodeLine{4 \textcolor{comment}{ * 设计原则：}}
\DoxyCodeLine{5 \textcolor{comment}{ * -\/ 零开销抽象：使用编译期宏，无运行时动态分配}}
\DoxyCodeLine{6 \textcolor{comment}{ * -\/ 固定管线：中间件顺序在编译时确定}}
\DoxyCodeLine{7 \textcolor{comment}{ * -\/ 简洁清晰：避免链表、优先级等复杂概念}}
\DoxyCodeLine{8 \textcolor{comment}{ * -\/ 应用层主导：中间件逻辑由应用层实现}}
\DoxyCodeLine{9 \textcolor{comment}{ *}}
\DoxyCodeLine{10 \textcolor{comment}{ * 使用示例：}}
\DoxyCodeLine{11 \textcolor{comment}{ *   int my\_handler(uvhttp\_request\_t* req, uvhttp\_response\_t* resp) \{}}
\DoxyCodeLine{12 \textcolor{comment}{ *       UVHTTP\_EXECUTE\_MIDDLEWARE(req, resp,}}
\DoxyCodeLine{13 \textcolor{comment}{ *           logging\_middleware,}}
\DoxyCodeLine{14 \textcolor{comment}{ *           auth\_middleware,}}
\DoxyCodeLine{15 \textcolor{comment}{ *           cors\_middleware}}
\DoxyCodeLine{16 \textcolor{comment}{ *       );}}
\DoxyCodeLine{17 \textcolor{comment}{ *       // 处理请求...}}
\DoxyCodeLine{18 \textcolor{comment}{ *   \}}}
\DoxyCodeLine{19 \textcolor{comment}{ *}}
\DoxyCodeLine{20 \textcolor{comment}{ * 重要说明：}}
\DoxyCodeLine{21 \textcolor{comment}{ * -\/ 如果中间件返回 UVHTTP\_MIDDLEWARE\_STOP，表示中间件已经处理了请求}}
\DoxyCodeLine{22 \textcolor{comment}{ * -\/ 处理器应该检查响应是否已经被发送，或者直接返回}}
\DoxyCodeLine{23 \textcolor{comment}{ * -\/ 推荐模式：在中间件返回 STOP 后，处理器应该立即返回}}
\DoxyCodeLine{24 \textcolor{comment}{ */}}
\DoxyCodeLine{25 }
\DoxyCodeLine{26 \textcolor{preprocessor}{\#ifndef UVHTTP\_MIDDLEWARE\_H}}
\DoxyCodeLine{27 \textcolor{preprocessor}{\#define UVHTTP\_MIDDLEWARE\_H}}
\DoxyCodeLine{28 }
\DoxyCodeLine{29 \textcolor{preprocessor}{\#include "{}uvhttp\_common.h"{}}}
\DoxyCodeLine{30 \textcolor{preprocessor}{\#include "{}uvhttp\_request.h"{}}}
\DoxyCodeLine{31 \textcolor{preprocessor}{\#include "{}uvhttp\_response.h"{}}}
\DoxyCodeLine{32 }
\DoxyCodeLine{33 \textcolor{preprocessor}{\#ifdef \_\_cplusplus}}
\DoxyCodeLine{34 \textcolor{keyword}{extern} \textcolor{stringliteral}{"{}C"{}} \{}
\DoxyCodeLine{35 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{36 }
\DoxyCodeLine{37 \textcolor{comment}{/* 中间件返回值 */}}
\DoxyCodeLine{38 \textcolor{preprocessor}{\#define UVHTTP\_MIDDLEWARE\_CONTINUE 0}}
\DoxyCodeLine{39 \textcolor{preprocessor}{\#define UVHTTP\_MIDDLEWARE\_STOP 1}}
\DoxyCodeLine{40 }
\DoxyCodeLine{41 \textcolor{comment}{/* 中间件上下文 */}}
\DoxyCodeLine{42 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }\mbox{\hyperlink{structuvhttp__middleware__context}{uvhttp\_middleware\_context}} \{}
\DoxyCodeLine{43     \textcolor{keywordtype}{void}* data;}
\DoxyCodeLine{44     void (*cleanup)(\textcolor{keywordtype}{void}* data);}
\DoxyCodeLine{45 \} \mbox{\hyperlink{structuvhttp__middleware__context}{uvhttp\_middleware\_context\_t}};}
\DoxyCodeLine{46 }
\DoxyCodeLine{47 \textcolor{comment}{/* 中间件处理函数类型 */}}
\DoxyCodeLine{48 \textcolor{keyword}{typedef} int (*uvhttp\_middleware\_handler\_t)(\mbox{\hyperlink{structuvhttp__request}{uvhttp\_request\_t}}* request,}
\DoxyCodeLine{49                                            \mbox{\hyperlink{structuvhttp__response}{uvhttp\_response\_t}}* response,}
\DoxyCodeLine{50                                            \mbox{\hyperlink{structuvhttp__middleware__context}{uvhttp\_middleware\_context\_t}}* ctx);}
\DoxyCodeLine{51 }
\DoxyCodeLine{52 \textcolor{comment}{/* 执行中间件链 */}}
\DoxyCodeLine{53 \textcolor{preprocessor}{\#define UVHTTP\_EXECUTE\_MIDDLEWARE(req, resp, ...)                          \(\backslash\)}}
\DoxyCodeLine{54 \textcolor{preprocessor}{    do \{                                                                   \(\backslash\)}}
\DoxyCodeLine{55 \textcolor{preprocessor}{        static const uvhttp\_middleware\_handler\_t \_uvhttp\_mw\_handlers[] = \{ \(\backslash\)}}
\DoxyCodeLine{56 \textcolor{preprocessor}{            \_\_VA\_ARGS\_\_\};                                                  \(\backslash\)}}
\DoxyCodeLine{57 \textcolor{preprocessor}{        uvhttp\_middleware\_context\_t \_uvhttp\_mw\_ctx = \{0\};                  \(\backslash\)}}
\DoxyCodeLine{58 \textcolor{preprocessor}{        for (size\_t \_uvhttp\_mw\_i = 0;                                      \(\backslash\)}}
\DoxyCodeLine{59 \textcolor{preprocessor}{             \_uvhttp\_mw\_i <                                                \(\backslash\)}}
\DoxyCodeLine{60 \textcolor{preprocessor}{             sizeof(\_uvhttp\_mw\_handlers) / sizeof(\_uvhttp\_mw\_handlers[0]); \(\backslash\)}}
\DoxyCodeLine{61 \textcolor{preprocessor}{             \_uvhttp\_mw\_i++) \{                                             \(\backslash\)}}
\DoxyCodeLine{62 \textcolor{preprocessor}{            if (\_uvhttp\_mw\_handlers[\_uvhttp\_mw\_i] \&\&                       \(\backslash\)}}
\DoxyCodeLine{63 \textcolor{preprocessor}{                \_uvhttp\_mw\_handlers[\_uvhttp\_mw\_i](req, resp,               \(\backslash\)}}
\DoxyCodeLine{64 \textcolor{preprocessor}{                                                  \&\_uvhttp\_mw\_ctx) !=      \(\backslash\)}}
\DoxyCodeLine{65 \textcolor{preprocessor}{                    UVHTTP\_MIDDLEWARE\_CONTINUE) \{                          \(\backslash\)}}
\DoxyCodeLine{66 \textcolor{preprocessor}{                if (\_uvhttp\_mw\_ctx.cleanup)                                \(\backslash\)}}
\DoxyCodeLine{67 \textcolor{preprocessor}{                    \_uvhttp\_mw\_ctx.cleanup(\_uvhttp\_mw\_ctx.data);           \(\backslash\)}}
\DoxyCodeLine{68 \textcolor{preprocessor}{                goto \_uvhttp\_mw\_stop;                                      \(\backslash\)}}
\DoxyCodeLine{69 \textcolor{preprocessor}{            \}                                                              \(\backslash\)}}
\DoxyCodeLine{70 \textcolor{preprocessor}{        \}                                                                  \(\backslash\)}}
\DoxyCodeLine{71 \textcolor{preprocessor}{    \} while (0);                                                           \(\backslash\)}}
\DoxyCodeLine{72 \textcolor{preprocessor}{\_uvhttp\_mw\_stop:                                                           \(\backslash\)}}
\DoxyCodeLine{73 \textcolor{preprocessor}{    (void)0}}
\DoxyCodeLine{74 }
\DoxyCodeLine{75 \textcolor{comment}{/* 定义中间件链（供复用） */}}
\DoxyCodeLine{76 \textcolor{preprocessor}{\#define UVHTTP\_DEFINE\_MIDDLEWARE\_CHAIN(name, ...)                  \(\backslash\)}}
\DoxyCodeLine{77 \textcolor{preprocessor}{    static const uvhttp\_middleware\_handler\_t name\#\#\_handlers[] = \{ \(\backslash\)}}
\DoxyCodeLine{78 \textcolor{preprocessor}{        \_\_VA\_ARGS\_\_\};                                              \(\backslash\)}}
\DoxyCodeLine{79 \textcolor{preprocessor}{    static const size\_t name\#\#\_count =                             \(\backslash\)}}
\DoxyCodeLine{80 \textcolor{preprocessor}{        sizeof(name\#\#\_handlers) / sizeof(name\#\#\_handlers[0])}}
\DoxyCodeLine{81 }
\DoxyCodeLine{82 \textcolor{comment}{/* 执行预定义的中间件链 */}}
\DoxyCodeLine{83 \textcolor{preprocessor}{\#define UVHTTP\_EXECUTE\_MIDDLEWARE\_CHAIN(req, resp, name)                     \(\backslash\)}}
\DoxyCodeLine{84 \textcolor{preprocessor}{    do \{                                                                     \(\backslash\)}}
\DoxyCodeLine{85 \textcolor{preprocessor}{        uvhttp\_middleware\_context\_t \_uvhttp\_mw\_ctx = \{0\};                    \(\backslash\)}}
\DoxyCodeLine{86 \textcolor{preprocessor}{        for (size\_t \_uvhttp\_mw\_i = 0; \_uvhttp\_mw\_i < name\#\#\_count;           \(\backslash\)}}
\DoxyCodeLine{87 \textcolor{preprocessor}{             \_uvhttp\_mw\_i++) \{                                               \(\backslash\)}}
\DoxyCodeLine{88 \textcolor{preprocessor}{            if (name\#\#\_handlers[\_uvhttp\_mw\_i] \&\&                             \(\backslash\)}}
\DoxyCodeLine{89 \textcolor{preprocessor}{                name\#\#\_handlers[\_uvhttp\_mw\_i](req, resp, \&\_uvhttp\_mw\_ctx) != \(\backslash\)}}
\DoxyCodeLine{90 \textcolor{preprocessor}{                    UVHTTP\_MIDDLEWARE\_CONTINUE) \{                            \(\backslash\)}}
\DoxyCodeLine{91 \textcolor{preprocessor}{                if (\_uvhttp\_mw\_ctx.cleanup)                                  \(\backslash\)}}
\DoxyCodeLine{92 \textcolor{preprocessor}{                    \_uvhttp\_mw\_ctx.cleanup(\_uvhttp\_mw\_ctx.data);             \(\backslash\)}}
\DoxyCodeLine{93 \textcolor{preprocessor}{                goto \_uvhttp\_mw\_stop\_\#\#name;                                 \(\backslash\)}}
\DoxyCodeLine{94 \textcolor{preprocessor}{            \}                                                                \(\backslash\)}}
\DoxyCodeLine{95 \textcolor{preprocessor}{        \}                                                                    \(\backslash\)}}
\DoxyCodeLine{96 \textcolor{preprocessor}{    \} while (0);                                                             \(\backslash\)}}
\DoxyCodeLine{97 \textcolor{preprocessor}{    \_uvhttp\_mw\_stop\_\#\#name : (void)0}}
\DoxyCodeLine{98 }
\DoxyCodeLine{99 \textcolor{preprocessor}{\#ifdef \_\_cplusplus}}
\DoxyCodeLine{100 \}}
\DoxyCodeLine{101 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{102 }
\DoxyCodeLine{103 \textcolor{preprocessor}{\#endif }\textcolor{comment}{/* UVHTTP\_MIDDLEWARE\_H */}\textcolor{preprocessor}{}}

\end{DoxyCode}
