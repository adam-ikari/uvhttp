# UVHTTP 性能基准测试

本文档记录了 UVHTTP 服务器的实际性能测试结果和基准数据。

## 测试环境

- **操作系统**: Linux 6.14.11-2-pve
- **CPU**: 未指定
- **编译器**: GCC (C11 标准)
- **性能测试工具**: wrk 4.2.0
- **测试日期**: 2026-01-12
- **测试服务器**: `performance_static_server` (CMake 编译)

## 测试配置

### 服务器配置

- **静态文件目录**: `./public/`
- **监听端口**: 8080
- **内存分配器**: mimalloc (默认)
- **Keep-Alive**: 启用
- **TCP_NODELAY**: 启用

### 测试参数

- **测试时长**: 30 秒
- **线程数**: 2-8 线程
- **并发连接**: 10-200 连接
- **测试工具**: `wrk -t{threads} -c{connections} -d30s`

## 性能基准数据

### 主页测试

测试 URL: `http://127.0.0.1:8080/`

| 线程数 | 连接数 | 总请求数 | RPS       | 平均延迟 | 传输速率  | 错误数 |
| ------ | ------ | -------- | --------- | -------- | --------- | ------ |
| 4      | 50     | 294,052  | **9,769** | 4.87ms   | 12.90MB/s | 0      |
| 4      | 100    | 279,460  | **9,290** | 11.53ms  | 12.27MB/s | 0      |
| 4      | 100    | 287,394  | **9,553** | 10.88ms  | 12.62MB/s | 0      |

**主页平均性能**: ~9,500 RPS

### 静态文件测试

#### 小文件 (index.html - 12B)

测试 URL: `http://127.0.0.1:8080/static/index.html`

| 线程数 | 连接数 | 总请求数 | RPS       | 平均延迟 | 传输速率 | 错误数 |
| ------ | ------ | -------- | --------- | -------- | -------- | ------ |
| 4      | 100    | 221,153  | **7,347** | 14.04ms  | 1.67MB/s | 0      |

#### 中等文件 (medium.html - 10KB)

测试 URL: `http://127.0.0.1:8080/static/medium.html`

| 线程数 | 连接数 | 总请求数 | RPS       | 平均延迟 | 传输速率  | 错误数 |
| ------ | ------ | -------- | --------- | -------- | --------- | ------ |
| 4      | 100    | 140,156  | **4,444** | 46.70ms  | 43.48MB/s | 0      |

**注意**: 测试中有 138 个超时错误 (Socket errors: timeout 138)

#### 大文件 (large.html - 100KB)

测试 URL: `http://127.0.0.1:8080/static/large.html`

| 线程数 | 连接数 | 总请求数 | RPS       | 平均延迟 | 传输速率   | 错误数 |
| ------ | ------ | -------- | --------- | -------- | ---------- | ------ |
| 4      | 100    | 138,844  | **4,622** | 23.54ms  | 441.91MB/s | 0      |

**静态文件平均性能**: ~5,500 RPS

### 性能总结

| 测试场景        | 平均 RPS | 平均延迟 | 传输速率   | 错误率 |
| --------------- | -------- | -------- | ---------- | ------ |
| 主页            | 9,537    | 9.09ms   | 12.60MB/s  | 0%     |
| 小文件 (12B)    | 7,347    | 14.04ms  | 1.67MB/s   | 0%     |
| 中等文件 (10KB) | 4,444    | 46.70ms  | 43.48MB/s  | 0.1%   |
| 大文件 (100KB)  | 4,622    | 23.54ms  | 441.91MB/s | 0%     |

## 性能分析

### 优势

1. **高吞吐量**: 主页测试达到 9,769 RPS
2. **低延迟**: 平均延迟在 4.87ms - 46.70ms 之间
3. **高带宽**: 大文件传输速率达到 441.91MB/s
4. **零错误**: 大部分测试无错误响应

### 性能特征

1. **文件大小影响**: 文件越大，RPS 越低，但传输速率越高
2. **并发影响**: 中等并发 (50 连接) 性能最优
3. **延迟分布**: 延迟波动较大 (标准差高)，99%+ 的请求延迟波动超过 75%

### 优化建议

1. **减少延迟波动**: 优化事件循环处理，减少延迟抖动
2. **提高小文件 RPS**: 优化小文件处理路径，减少系统调用
3. **处理超时错误**: 调查中等文件测试中的超时问题
4. **缓存优化**: 为频繁访问的小文件启用内容缓存

## 测试方法

### 运行测试

```bash
# 使用 CMake 编译测试服务器
cd build
make performance_static_server

# 运行性能测试
cd ..
./test/run_uvhttp_performance_local.sh
```

### 测试脚本

测试脚本位置: `test/run_uvhttp_performance_local.sh`

测试结果保存: `test/uvhttp_performance_results/`

### 测试文件

静态文件测试使用以下文件：

- `public/static/index.html` (12B) - 小文件测试
- `public/static/medium.html` (10KB) - 中等文件测试
- `public/static/large.html` (100KB) - 大文件测试

## 历史数据对比

### 之前的问题

在 2026-01-12 之前的测试中，静态文件测试出现 100% 错误响应：

- **错误原因**: 测试脚本配置的文件 `test.html` 不存在
- **错误数量**: 95,681 个错误响应 (100%)
- **修复方法**: 更新测试脚本使用存在的文件 `index.html`

### 修复后的结果

修复后，所有测试均返回正确的 2xx 响应，错误率为 0%。

## 注意事项

1. **测试环境**: 性能测试结果受系统负载、网络状况等影响
2. **测试工具**: 必须使用 CMake 编译的程序，不得直接使用 GCC 编译
3. **测试文件**: 确保测试文件存在且可访问
4. **测试时长**: 每个测试至少运行 30 秒以获得稳定结果
5. **测试验证**: 检查测试结果中的 "Non-2xx or 3xx responses" 字段

## 参考文档

- [性能测试标准](PERFORMANCE_TESTING_STANDARD.md)
- [静态文件服务](STATIC_FILE_SERVER.md)
- [开发者指南](DEVELOPER_GUIDE.md)

---

**文档版本**: 1.0
**最后更新**: 2026-01-12
**维护者**: UVHTTP Team
