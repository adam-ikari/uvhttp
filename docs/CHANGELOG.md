# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [1.4.0] - 2026-01-13

### Added
- **WebSocket 认证功能**: Token 认证、IP 白名单/黑名单
- **WebSocket 连接管理**: 连接池、超时检测、心跳检测、广播功能
- **内存管理优化**: 使用内联函数替代宏定义

### Changed
- **内存分配器 API**: 从宏改为内联函数（uvhttp_alloc/uvhttp_free）
- **WebSocket 实现**: 完全原生实现，移除 libwebsockets 依赖

### Fixed
- **内存泄漏**: 修复 WebSocket 连接管理中的内存泄漏
- **认证逻辑**: 修复 IP 白名单/黑名单匹配逻辑

### Breaking Changes
- **内存分配器 API**: UVHTTP_MALLOC/UVHTTP_FREE 改为 uvhttp_alloc/uvhttp_free

## [1.4.0] - 2026-01-11

### Added
- **改进的超时检测机制**: 使用 libuv 定时器实现主动超时检测
- **配置值文档说明**: 添加 sendfile 配置参数选择依据
- **性能基准测试**: 完整的性能测试数据（15,000+ RPS）

### Changed
- **sendfile 超时检测**: 从被动检测改为主动检测
- **示例程序内存管理**: 统一使用 UVHTTP_MALLOC/UVHTTP_FREE
- **文档完善**: 添加性能优化章节到 STATIC_FILE_SERVER.md

### Fixed
- **中等文件传输超时**: 使用分块发送（1MB chunks）
- **示例程序内存泄漏**: 修复所有示例程序的内存管理不一致问题
- **超时检测不完整**: 确保网络完全阻塞时也能及时响应

### Performance
- **性能测试结果**: 
  - 主页: 15,967 RPS (79.8% 目标)
  - 中等文件: 14,285 RPS (71.4% 目标)
  - 大文件: 15,480 RPS (77.4% 目标)
  - 平均延迟: 3-6ms
- **分块传输影响**: 性能影响 < 1%

### Testing
- **测试通过率**: 100% (所有现有测试)
- **性能测试**: wrk 测试全部通过
- **代码质量**: 零编译警告

## [1.3.2] - 2026-01-11

### Added
- **sendfile 超时测试**: test_sendfile_timeout.c 测试用例

### Fixed
- **中等文件传输超时**: 使用分块发送（每次64KB，优化后）
- **超时检测**: 添加10秒超时检测（优化后）
- **错误处理**: 改进错误处理，添加重试机制（最多2次，优化后）

### Testing
- **测试通过率**: 100% (10/10)
- **测试覆盖**: 中等文件、边界情况、分类测试

## [1.3.1] - 2026-01-11

### Added
- **分支管理规范**: 完整的Git Flow分支管理策略
- **Linux 内核开发节奏**: 持续开发-快速修复-稳定发布

### Changed
- **开发流程**: 采用 Git Flow 分支管理策略

## [1.3.0] - 2026-01-11

### Added
- **分支管理规范**: 完整的Git Flow分支管理策略和开发规范
- **性能对比测试**: Nginx vs UVHTTP性能对比综合报告
- **性能测试标准**: 详细的性能测试标准文档
- **服务器配置指南**: 服务器配置性能优化指南
- **限流功能**: 完整的限流功能实现和API文档
- **性能测试工具**: 全面的性能测试框架和工具

### Changed
- **限流API重构**: 将限流功能从中间件改为服务器核心功能
- **中间件系统**: 实现零开销中间件系统
- **静态文件服务**: 静态文件中间件解耦，性能优化
- **错误码机制**: 增强错误码机制和错误处理
- **WebSocket功能**: 完善WebSocket功能，添加路由支持

### Fixed
- **白名单内存泄漏**: 修复白名单哈希表内存泄漏和重复添加问题
- **NULL参数处理**: 修复uvhttp_request_get_path的NULL参数处理
- **测试崩溃**: 修复test_request_null_coverage测试崩溃问题
- **PR评审问题**: 修复PR评审中发现的关键问题

### Performance
- **性能优化**: 完成性能优化和代码质量改进
- **测试覆盖**: 添加全面的限流功能测试框架
- **API简化**: 简化限流API，移除未使用的算法参数

### Testing
- **测试通过率**: 所有测试通过 (69/69, 100%)
- **NULL参数测试**: 完整的NULL参数覆盖测试
- **性能验证**: 性能基准测试验证通过

### Documentation
- **开发指南**: 更新开发指南，包含分支管理规范
- **性能文档**: 添加性能测试标准和配置指南
- **API文档**: 添加限流功能API文档
- **测试文档**: 添加性能对比测试报告

### Breaking Changes
- **限流API变更**: 限流功能从中间件改为服务器核心功能，API有所变化

## [1.2.0] - 2026-01-07

### Added
- **TLS安全功能**: 实现CRL检查、DH参数设置、会话票证管理、证书链验证
- **性能基准测试**: 新增性能基准测试程序和文档
- **安全策略文档**: 完整的安全策略和依赖管理文档
- **mimalloc支持**: 启用mimalloc作为默认内存分配器
- **原生WebSocket**: 使用原生WebSocket实现替代libwebsockets

### Changed
- **TLS实现**: 从OpenSSL迁移到mbedTLS，提升安全性和性能
- **性能优化**: Keep-alive连接管理优化，性能提升约1000倍（4-16 RPS → 14,000-16,000 RPS）
- **代码精简**: 移除15,192行冗余代码，提升代码可维护性
- **文档重组**: 移动文档到docs/目录，优化项目结构
- **依赖管理**: 清理.gitmodules，移除不再使用的依赖

### Fixed
- **空指针检查**: 修复request getter函数的空指针检查（11个函数）
- **TLS类型错误**: 修复mbedTLS API类型不兼容问题
- **编译警告**: 修复所有编译警告（未使用变量、strncpy截断等）
- **HTTP头验证**: 修复HTTP头验证逻辑错误
- **响应构建**: 修复响应数据构建时机问题

### Security
- **CRL检查**: 实现证书撤销列表检查功能
- **证书链验证**: 完整的证书链验证支持
- **依赖更新策略**: 明确的安全更新、功能更新、维护更新策略
- **安全审计**: 建立每周依赖扫描、每月代码审查、季度渗透测试计划
- **漏洞响应**: 定义完整的漏洞发现、评估、修复、通知流程

### Performance
- **Keep-alive连接**: 修复连接复用，性能提升约1000倍
- **TCP优化**: 启用TCP_NODELAY和TCP keepalive
- **响应缓冲区**: 优化响应缓冲区大小（512 → 1024字节）
- **内存分配器**: mimalloc提供更快的内存分配和释放

### Testing
- **NULL参数测试**: 完整的NULL参数覆盖测试（TLS 32个，Request 11个）
- **性能验证**: 1000倍性能提升已通过基准测试验证
- **代码质量**: 编译无错误无警告，启用安全编译选项

### Documentation
- **PERFORMANCE_BENCHMARK.md**: 详细的性能基准测试文档
- **SECURITY.md**: 完整的安全策略文档
- **依赖文档**: 更新DEPENDENCIES.md，包含所有依赖版本和更新策略

### Breaking Changes
- **TLS API变更**: 从OpenSSL迁移到mbedTLS，API签名有所变化
- **WebSocket实现**: 从libwebsockets迁移到原生实现
- **依赖变更**: 移除libwebsockets依赖，使用mbedTLS替代OpenSSL

## [1.1.0] - 2025-12-25

### Added
- **内存安全增强**: 使用C99灵活数组成员解决内存对齐问题
- **整数溢出保护**: 在所有关键内存分配点添加整数溢出检查
- **路径遍历防护**: 多层路径遍历保护机制，防止目录遍历攻击
- **性能优化**: 增加连接数限制（2048）和监听队列（1024）
- **新常量定义**: 添加HTTP状态码范围常量和响应头安全边距常量
- **文档**: 新增ROUTER_SEARCH_MODES.md文档
- **WebSocket全局清理**: 完善WebSocket全局资源清理函数

### Changed
- **API统一**: 统一所有验证函数返回值（1表示有效/成功，0表示无效/失败）
- **函数命名**: 移除所有兼容性包装函数，使用统一的API命名
- **代码清理**: 移除所有兼容性代码和注释
- **测试更新**: 更新所有测试以匹配新的API签名
- **错误处理**: 简化错误处理逻辑，提高代码可读性

### Fixed
- **内存对齐**: 修复uvhttp_write_data_t结构的内存对齐问题
- **内存泄漏**: 修复错误处理路径中的内存泄漏
- **危险字符检查**: 移除错误null字符检查逻辑
- **函数返回值**: 修正验证函数的返回值逻辑
- **编译错误**: 修复所有示例程序和测试程序的编译错误

### Security
- **缓冲区溢出保护**: 添加完整的边界检查和整数溢出检查
- **HTTP响应拆分防护**: 增强控制字符检测
- **DoS防护**: 合理的资源限制和超时配置
- **TLS支持**: 支持TLS 1.3加密协议
- **输入验证**: 28处输入验证调用，覆盖所有用户输入点

### Performance
- **哈希算法**: 使用xxHash高性能哈希算法
- **LRU缓存**: 优化路由缓存和静态文件缓存
- **零拷贝**: 减少内存拷贝操作
- **连接池**: 优化连接复用和管理

### Testing
- **单元测试**: 16/16测试通过（100%通过率）
- **测试覆盖**: 47%测试代码量
- **边界测试**: 完整的边界条件和极端条件测试
- **安全测试**: 路径遍历、DoS防护等安全测试

### Documentation
- **API文档**: 完整的API参考文档
- **开发指南**: 详细的开发指南和规范
- **架构文档**: 清晰的架构说明
- **示例代码**: 15个示例程序

## [1.0.0] - 2025-12-20

### Added
- **初始发布**: 基于libuv的高性能HTTP服务器
- **路由系统**: 支持动态路由和参数提取
- **静态文件服务**: 高效的静态文件服务
- **WebSocket支持**: 完整的WebSocket协议支持
- **TLS/SSL**: 支持HTTPS加密连接
- **LRU缓存**: 高性能缓存系统
- **连接池**: 优化连接复用
- **配置系统**: 灵活的配置管理
- **错误处理**: 完善的错误处理和日志系统

### Features
- 单线程事件驱动模型
- 高性能异步I/O
- 模块化设计
- 可扩展的插件系统
- 详细的文档和示例

[1.1.0]: https://github.com/adam-ikari/uvhttp/compare/v1.0.0...v1.1.0
[1.0.0]: https://github.com/adam-ikari/uvhttp/releases/tag/v1.0.0