name: CI/CD - Release Build

# 触发条件：Push tag matching v* (如 v1.5.0)
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # ========== 阶段 1: 多平台 Release 构建 ==========
  
  ubuntu-release-build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: release-${{ steps.get_version.outputs.version }}
          build-type: Release
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_WITH_WEBSOCKET=ON \
            -DBUILD_WITH_MIMALLOC=ON
      
      - name: Build
        run: |
          cmake --build build --config Release -j$(nproc)
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-ubuntu-release-${{ steps.get_version.outputs.version }}
          path: build/
          retention-days: 30
  
  macos-release-build:
    runs-on: macos-latest
    timeout-minutes: 30
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: macos-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: release-${{ steps.get_version.outputs.version }}
          build-type: Release
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_WITH_WEBSOCKET=ON \
            -DBUILD_WITH_MIMALLOC=ON
      
      - name: Build
        run: |
          cmake --build build --config Release -j$(sysctl -n hw.ncpu)
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-macos-release-${{ steps.get_version.outputs.version }}
          path: build/
          retention-days: 30
  
  windows-release-build:
    runs-on: windows-latest
    timeout-minutes: 35
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Get version from tag
        id: get_version
        run: |
          $VERSION = $env:GITHUB_REF -replace 'refs/tags/v', ''
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: windows-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: release-${{ steps.get_version.outputs.version }}
          build-type: Release
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_WITH_WEBSOCKET=ON `
            -DBUILD_WITH_MIMALLOC=ON
      
      - name: Build
        run: |
          cmake --build build --config Release -j
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-windows-release-${{ steps.get_version.outputs.version }}
          path: build/
          retention-days: 30
  
  # ========== 阶段 2: 发布测试 ==========
  
  release-test:
    needs: [ubuntu-release-build, macos-release-build, windows-release-build]
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Download all build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          pattern: build-*-release-*
          path: builds/
          merge-multiple: false
      
      - name: Run release tests
        run: |
          for build_dir in builds/*/; do
            echo "Testing $build_dir"
            cd "$build_dir/build"
            ctest --output-on-failure -j$(nproc) --timeout 120
            cd -
          done
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: release-test-logs-${{ needs.ubuntu-release-build.outputs.version }}
          path: builds/*/build/Testing/
          retention-days: 30
  
  # ========== 阶段 3: 创建 Release ==========
  
  create-release:
    needs: [release-test]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Download all build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          pattern: build-*-release-*
          path: packages/
          merge-multiple: false
      
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ needs.ubuntu-release-build.outputs.version }}
          
          cat > release-notes.md << 'EOF'
          # UVHTTP $VERSION Release
          
          ## Changes
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes.
          
          ## Installation
          
          ### Linux
          ```bash
          # Build from source
          git clone https://github.com/adam-ikari/uvhttp.git
          cd uvhttp
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . -j$(nproc)
          ```
          
          ### macOS
          ```bash
          # Build from source
          git clone https://github.com/adam-ikari/uvhttp.git
          cd uvhttp
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . -j$(sysctl -n hw.ncpu)
          ```
          
          ### Windows
          ```powershell
          # Build from source
          git clone https://github.com/adam-ikari/uvhttp.git
          cd uvhttp
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . --config Release
          ```
          
          ## Verification
          
          All platforms have been tested and verified.
          
          ## Performance
          
          Performance benchmarks are available in the artifacts.
          
          ## Documentation
          
          Documentation is available at https://adam-ikari.github.io/uvhttp/
          EOF
          
          echo "notes_path=release-notes.md" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: UVHTTP ${{ needs.ubuntu-release-build.outputs.version }}
          body_path: ${{ steps.release_notes.outputs.notes_path }}
          draft: false
          prerelease: false
          files: |
            packages/build-ubuntu-release-${{ needs.ubuntu-release-build.outputs.version }}/opt/uvhttp-${{ needs.ubuntu-release-build.outputs.version }}-linux-x86_64.tar.gz
            packages/build-macos-release-${{ needs.macos-release-build.outputs.version }}/opt/uvhttp-${{ needs.macos-release-build.outputs.version }}-macos-x86_64.tar.gz
            packages/build-windows-release-${{ needs.windows-release-build.outputs.version }}/uvhttp-${{ needs.windows-release-build.outputs.version }}-windows-x86_64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # ========== 阶段 4: 更新性能基线 ==========
  
  update-baseline:
    needs: [create-release]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download release artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-release-${{ needs.ubuntu-release-build.outputs.version }}
          path: build/
      
      - name: Run performance benchmark
        run: |
          chmod +x build/dist/bin/benchmark_rps
          
          build/dist/bin/benchmark_rps > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          sleep 3
          
          wrk -t4 -c100 -d10s http://localhost:18081/ > performance.log
          
          kill $SERVER_PID 2>/dev/null || true
      
      - name: Update baseline in codebase
        run: |
          VERSION=${{ needs.ubuntu-release-build.outputs.version }}
          
          # 解析性能结果
          RPS=$(grep "Requests/sec:" performance.log | awk '{print $2}')
          
          # 创建基线文件
          mkdir -p docs/performance
          cat > docs/performance/baseline-$VERSION.json << EOF
          {
            "version": "$VERSION",
            "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "baseline": {
              "rps": $RPS,
              "platform": "ubuntu-latest"
            }
          }
          EOF
          
          # 更新当前基线
          cp docs/performance/baseline-$VERSION.json docs/performance/baseline.json
          
          # 创建新分支用于基线更新
          BRANCH_NAME="update-baseline-v${VERSION}"
          git checkout -b $BRANCH_NAME
          
          # 提交基线更新
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/performance/
          git commit -m "chore: 更新性能基线到 v$VERSION [skip ci]"
          
          # 推送分支
          git push origin $BRANCH_NAME
          
          # 创建 PR（添加错误处理）
          if gh pr create \
            --title "Update performance baseline to v$VERSION" \
            --body "Automated baseline update for release v$VERSION

          ### Performance Metrics
          - **RPS**: $RPS
          - **Platform**: ubuntu-latest
          - **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          This PR was automatically created by the ci-release workflow." \
            --base main \
            --head $BRANCH_NAME \
            --label "automated" \
            --label "performance" \
            --label "skip-ci"; then
            echo "✅ PR created successfully"
          else
            # PR 可能已存在，检查并更新
            if ! gh pr view $BRANCH_NAME --json title --jq '.title' > /dev/null 2>&1; then
              echo "⚠️ Failed to create PR (may already exist or permission issue)"
              echo "Branch $BRANCH_NAME was pushed, please create PR manually if needed"
            else
              echo "✅ PR already exists"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}