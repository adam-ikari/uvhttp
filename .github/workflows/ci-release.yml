name: CI/CD - Release Build

# 触发条件：Push tag matching v* (如 v1.5.0)
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # ========== 阶段 1: 多平台 Release 构建 ==========
  
  ubuntu-release-build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: release-${{ steps.get_version.outputs.version }}
          build-type: Release
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_WITH_WEBSOCKET=ON \
            -DBUILD_WITH_MIMALLOC=ON \
            -DCMAKE_INSTALL_PREFIX=/opt/uvhttp
      
      - name: Build
        run: |
          cmake --build build --config Release -j$(nproc)
      
      - name: Install
        run: |
          sudo cmake --install build
      
      - name: Create release package
        run: |
          cd /opt
          tar czf uvhttp-${{ steps.get_version.outputs.version }}-linux-x86_64.tar.gz uvhttp/
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-ubuntu-release-${{ steps.get_version.outputs.version }}
          path: |
            build/
            /opt/uvhttp-${{ steps.get_version.outputs.version }}-linux-x86_64.tar.gz
          retention-days: 30
  
  macos-release-build:
    runs-on: macos-latest
    timeout-minutes: 30
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: macos-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: release-${{ steps.get_version.outputs.version }}
          build-type: Release
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_WITH_WEBSOCKET=ON \
            -DBUILD_WITH_MIMALLOC=ON \
            -DCMAKE_INSTALL_PREFIX=/opt/uvhttp
      
      - name: Build
        run: |
          cmake --build build --config Release -j$(sysctl -n hw.ncpu)
      
      - name: Install
        run: |
          sudo cmake --install build
      
      - name: Create release package
        run: |
          cd /opt
          tar czf uvhttp-${{ steps.get_version.outputs.version }}-macos-x86_64.tar.gz uvhttp/
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-macos-release-${{ steps.get_version.outputs.version }}
          path: |
            build/
            /opt/uvhttp-${{ steps.get_version.outputs.version }}-macos-x86_64.tar.gz
          retention-days: 30
  
  windows-release-build:
    runs-on: windows-latest
    timeout-minutes: 35
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Get version from tag
        id: get_version
        run: |
          $VERSION = $env:GITHUB_REF -replace 'refs/tags/v', ''
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: windows-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: release-${{ steps.get_version.outputs.version }}
          build-type: Release
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_WITH_WEBSOCKET=ON `
            -DBUILD_WITH_MIMALLOC=ON `
            -DCMAKE_INSTALL_PREFIX=C:/uvhttp
      
      - name: Build
        run: |
          cmake --build build --config Release -j
      
      - name: Install
        run: |
          cmake --install build
      
      - name: Create release package
        run: |
          Compress-Archive -Path C:/uvhttp/* -DestinationPath uvhttp-${{ steps.get_version.outputs.version }}-windows-x86_64.zip
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-release-${{ steps.get_version.outputs.version }}
          path: |
            build/
            uvhttp-${{ steps.get_version.outputs.version }}-windows-x86_64.zip
          retention-days: 30
  
  # ========== 阶段 2: 发布测试 ==========
  
  release-test:
    needs: [ubuntu-release-build, macos-release-build, windows-release-build]
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-*-release-*
          path: builds/
          merge-multiple: false
      
      - name: Run release tests
        run: |
          for build_dir in builds/*/; do
            echo "Testing $build_dir"
            cd "$build_dir/build"
            ctest --output-on-failure -j$(nproc) --timeout 120
            cd -
          done
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-test-logs-${{ needs.ubuntu-release-build.outputs.version }}
          path: builds/*/build/Testing/
          retention-days: 30
  
  # ========== 阶段 3: 创建 Release ==========
  
  create-release:
    needs: [release-test]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-*-release-*
          path: packages/
          merge-multiple: false
      
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ needs.ubuntu-release-build.outputs.version }}
          
          cat > release-notes.md << 'EOF'
          # UVHTTP $VERSION Release
          
          ## Changes
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes.
          
          ## Installation
          
          ### Linux
          ```bash
          tar xzf uvhttp-$VERSION-linux-x86_64.tar.gz
          cd uvhttp
          sudo cmake --install .
          ```
          
          ### macOS
          ```bash
          tar xzf uvhttp-$VERSION-macos-x86_64.tar.gz
          cd uvhttp
          sudo cmake --install .
          ```
          
          ### Windows
          ```powershell
          Expand-Archive uvhttp-$VERSION-windows-x86_64.zip
          cd uvhttp
          cmake --install .
          ```
          
          ## Verification
          
          All platforms have been tested and verified.
          
          ## Performance
          
          Performance benchmarks are available in the artifacts.
          
          ## Documentation
          
          Documentation is available at https://adam-ikari.github.io/uvhttp/
          EOF
          
          echo "notes_path=release-notes.md" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: UVHTTP ${{ needs.ubuntu-release-build.outputs.version }}
          body_path: ${{ steps.release_notes.outputs.notes_path }}
          draft: false
          prerelease: false
          files: |
            packages/build-ubuntu-release-${{ needs.ubuntu-release-build.outputs.version }}/opt/uvhttp-${{ needs.ubuntu-release-build.outputs.version }}-linux-x86_64.tar.gz
            packages/build-macos-release-${{ needs.macos-release-build.outputs.version }}/opt/uvhttp-${{ needs.macos-release-build.outputs.version }}-macos-x86_64.tar.gz
            packages/build-windows-release-${{ needs.windows-release-build.outputs.version }}/uvhttp-${{ needs.windows-release-build.outputs.version }}-windows-x86_64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # ========== 阶段 4: 更新性能基线 ==========
  
  update-baseline:
    needs: [create-release]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-release-${{ needs.ubuntu-release-build.outputs.version }}
          path: build/
      
      - name: Run performance benchmark
        run: |
          chmod +x build/dist/bin/performance_static_server
          mkdir -p build/public
          echo "<html><body><h1>Performance Test</h1></body></html>" > build/public/index.html
          
          build/dist/bin/performance_static_server -d build/public -p 8080 > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          sleep 3
          
          wrk -t4 -c100 -d10s http://localhost:8080/ > performance.log
          
          kill $SERVER_PID 2>/dev/null || true
      
      - name: Update baseline in codebase
        run: |
          VERSION=${{ needs.ubuntu-release-build.outputs.version }}
          
          # 解析性能结果
          RPS=$(grep "Requests/sec:" performance.log | awk '{print $2}')
          
          # 创建基线文件
          mkdir -p docs/performance
          cat > docs/performance/baseline-$VERSION.json << EOF
          {
            "version": "$VERSION",
            "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "baseline": {
              "rps": $RPS,
              "platform": "ubuntu-latest"
            }
          }
          EOF
          
          # 更新当前基线
          cp docs/performance/baseline-$VERSION.json docs/performance/baseline.json
          
          # 提交基线更新
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/performance/
          git diff --staged --quiet || git commit -m "chore: 更新性能基线到 v$VERSION [skip ci]"
          git push origin main