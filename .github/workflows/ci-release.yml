name: CI/CD - Release Build

# 触发条件：Push tag matching v* (如 v1.5.0)
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # ========== 阶段 1: Linux Release 构建 ==========
  
  ubuntu-release-build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: release-${{ steps.get_version.outputs.version }}
          build-type: Release
      
      - name: Build project
        run: |
          make build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-ubuntu-release-${{ steps.get_version.outputs.version }}
          path: build/
          retention-days: 30
  
  # ========== 阶段 2: 发布测试 ==========
  
  release-test:
    needs: [ubuntu-release-build]
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-release-${{ needs.ubuntu-release-build.outputs.version }}
          path: build/
      
      - name: Run release tests
        run: |
          ./test_runner.sh
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: release-test-logs-${{ needs.ubuntu-release-build.outputs.version }}
          path: build/Testing/
          retention-days: 30
  
  # ========== 阶段 3: 创建 Release ==========
  
  create-release:
    needs: [release-test]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-release-${{ needs.ubuntu-release-build.outputs.version }}
          path: build/
      
      - name: Create release archive
        run: |
          VERSION=${{ needs.ubuntu-release-build.outputs.version }}
          mkdir -p release
          
          # 复制库文件
          cp -r build/dist/lib release/
          
          # 复制头文件
          cp -r include release/
          
          # 创建归档
          tar -czf uvhttp-${VERSION}-linux-x86_64.tar.gz -C release .
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: uvhttp-${{ needs.ubuntu-release-build.outputs.version }}-linux-x86_64.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
