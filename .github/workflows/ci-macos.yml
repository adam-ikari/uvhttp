name: CI/CD Pipeline (macOS)

on:
  push:
    branches: [ main, develop, release, release/*, feature/* ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cmake --build build --config Release -j$(sysctl -n hw.ncpu)

    - name: Run smoke tests
      run: |
        cd build
        if [ -f "./test_smoke" ]; then
          ./test_smoke || {
            echo "Smoke tests failed"
            exit 1
          }
        else
          echo "test_smoke not found, skipping smoke tests"
        fi

    - name: Run fast tests
      run: |
        cd build
        ctest --output-on-failure -j1 --timeout 60 --label-regex "^fast$" --schedule-random || {
          echo "Fast tests failed or timed out"
          exit 1
        }

    - name: Run death tests
      run: |
        cd build
        if [ -f "./test_death" ]; then
          ./test_death || {
            echo "Death tests failed"
            exit 1
          }
        else
          echo "test_death not found, skipping death tests"
        fi

    - name: Check for warnings
      run: |
        if cmake --build build --config Release 2>&1 | grep -i "warning:"; then
          echo "Found compiler warnings!"
          exit 1
        fi

  performance-test:
    runs-on: macos-latest
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake wrk

    - name: Build project with examples
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_EXAMPLES=ON
        cmake --build build --config Release -j$(sysctl -n hw.ncpu)

    - name: Run performance tests
      run: |
        mkdir -p build/public
        echo "<html><body><h1>Performance Test</h1></body></html>" > build/public/index.html
        echo "Test file content" > build/public/test.txt
        cd build
        if [ -f "./dist/bin/performance_static_server" ]; then
          ./dist/bin/performance_static_server -d ./public -p 8080 > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          
          # 等待服务器启动，最多等待 10 秒
          TIMEOUT=10
          COUNT=0
          while [ $COUNT -lt $TIMEOUT ]; do
            if curl -s http://localhost:8080/ > /dev/null 2>&1; then
              echo "Server started successfully"
              break
            fi
            sleep 1
            COUNT=$((COUNT + 1))
          done
          
          if [ $COUNT -eq $TIMEOUT ]; then
            echo "Server failed to start within $TIMEOUT seconds"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          
          # 运行性能测试
          wrk -t4 -c100 -d10s --timeout 5s http://localhost:8080/
          WRK_EXIT=$?
          
          # 清理
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true
          
          if [ $WRK_EXIT -ne 0 ]; then
            echo "Performance test failed with exit code: $WRK_EXIT"
            exit 1
          fi
        else
          echo "performance_static_server not found, skipping performance test"
        fi

  stress-test:
    runs-on: macos-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/')

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake

    - name: Build project
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release -j$(sysctl -n hw.ncpu)

    - name: Run stress tests
      run: |
        cd build
        if [ -f "./dist/bin/test_stress" ]; then
          ./dist/bin/test_stress || {
            echo "Stress tests failed"
            exit 1
          }
        else
          echo "test_stress not found, skipping stress tests"
        fi

  memory-test:
    runs-on: macos-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/')

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake

    - name: Build project with AddressSanitizer
      run: |
        cmake -B build-asan -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g" -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g"
        cmake --build build-asan --config Debug -j$(sysctl -n hw.ncpu)

    - name: Run tests with AddressSanitizer
      run: |
        cd build-asan
        export ASAN_OPTIONS=detect_leaks=1:halt_on_error=0
        ctest --output-on-failure -j1 --timeout 120 || {
          echo "Tests with AddressSanitizer failed"
          exit 1
        }

    - name: Build project for memory leak check
      run: |
        cmake -B build-leak -DCMAKE_BUILD_TYPE=Debug
        cmake --build build-leak --config Debug -j$(sysctl -n hw.ncpu)

    - name: Run memory tests
      run: |
        cd build-leak
        if [ -f "./dist/bin/test_memory" ]; then
          ./dist/bin/test_memory || {
            echo "Memory tests failed"
            exit 1
          }
        else
          echo "test_memory not found, skipping memory tests"
        fi

    - name: Run Leaks memory leak check on key tests
      run: |
        cd build-leak
        # 运行关键测试的内存泄漏检查（使用 macOS Leaks 工具）
        TESTS=(
          "test_connection_full_coverage"
          "test_server_full_coverage"
          "test_request_full_coverage"
          "test_config_full_coverage"
        )

        LEAKS_FOUND=0
        for test in "${TESTS[@]}"; do
          if [ -f "./dist/bin/$test" ]; then
            echo "Running Leaks on $test..."
            MallocStackLogging=1 leaks --atExit -- ./dist/bin/$test > /tmp/leaks_${test}.log 2>&1
            EXIT_CODE=$?

            if [ $EXIT_CODE -ne 0 ]; then
              echo "❌ Memory leak detected in $test"
              cat /tmp/leaks_${test}.log
              LEAKS_FOUND=1
            else
              echo "✅ No memory leaks in $test"
            fi
          else
            echo "⚠️  $test not found, skipping"
          fi
        done

        if [ $LEAKS_FOUND -eq 1 ]; then
          echo "Memory leaks detected in one or more tests"
          exit 1
        fi

    - name: Upload Valgrind logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: valgrind-logs-macos
        path: /tmp/valgrind_*.log
        retention-days: 7

    - name: Upload AddressSanitizer logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: asan-logs-macos
        path: |
          build-asan/Testing/
          build-asan/**/asan.log
        retention-days: 7

  code-quality:
    runs-on: macos-latest
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake clang-tidy cppcheck lcov

    - name: Build project
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug
        cmake --build build --config Debug -j$(sysctl -n hw.ncpu)

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,performance,portability --error-exitcode=0 --suppress=missingIncludeSystem --suppress=unusedFunction --suppress=constParameter --suppress=unusedStructMember \
          -DUVHTTP_STRINGIFY\(x\)=\#x \
          -DUVHTTP_FEATURE_WEBSOCKET=1 \
          -DUVHTTP_FEATURE_STATIC_FILES=1 \
          -DUVHTTP_FEATURE_TLS=1 \
          -DUVHTTP_FEATURE_RATE_LIMIT=1 \
          -DUVHTTP_FEATURE_LOGGING=1 \
          -DUVHTTP_FEATURE_LRU_CACHE=1 \
          -DUVHTTP_FEATURE_ROUTER_CACHE=1 \
          -DUVHTTP_ENABLE_ROUTER_CACHE_OPTIMIZATION=1 \
          -DUVHTTP_ROUTER_SEARCH_MODE=2 \
          src/ || echo "cppcheck completed with warnings"

    - name: Memory leak check
      run: |
        cd build
        # 运行关键测试的内存泄漏检查
        TESTS=(
          "test_connection_full_coverage"
          "test_server_full_coverage"
          "test_request_full_coverage"
          "test_config_full_coverage"
        )
        
        for test in "${TESTS[@]}"; do
          if [ -f "./dist/bin/$test" ]; then
            echo "Running Valgrind on $test..."
            valgrind --leak-check=full --error-exitcode=1 --show-leak-kinds=all --track-origins=yes ./dist/bin/$test > /tmp/valgrind_${test}.log 2>&1
            if [ $? -ne 0 ]; then
              echo "❌ Memory leak detected in $test"
              cat /tmp/valgrind_${test}.log
              exit 1
            else
              echo "✅ No memory leaks in $test"
            fi
          fi
        done

  docs-build:
    runs-on: macos-latest
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: docs/package-lock.json

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Install dependencies
      working-directory: ./docs
      run: |
        pnpm install

    - name: Build docs
      working-directory: ./docs
      run: |
        pnpm build

    - name: Verify build output
      working-directory: ./docs
      run: |
        if [ ! -d ".vitepress/dist" ]; then
          echo "Error: Build output directory not found"
          exit 1
        fi
        if [ ! -f ".vitepress/dist/index.html" ]; then
          echo "Error: index.html not found in build output"
          exit 1
        fi
        echo "Docs build verification passed"