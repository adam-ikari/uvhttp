name: CI/CD - Performance Benchmark

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 0:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  # åˆ¤æ–­æ˜¯å¦ä¸º PR è§¦å‘
  IS_PR: ${{ github.event_name == 'pull_request' }}

jobs:
  performance-benchmark:
    runs-on: ubuntu-22.04
    # è¶…æ—¶è®¾ç½®è¯´æ˜Žï¼š
    # - PR å¿«é€Ÿæµ‹è¯•ï¼š5åˆ†é’Ÿ = 3ä¸ªæµ‹è¯•Ã—5ç§’ + 3ç§’å¯åŠ¨ + 2ç§’æ¸…ç† + å®‰å…¨ä½™é‡
    # - å®Œæ•´æµ‹è¯•ï¼š30åˆ†é’Ÿ = 3ä¸ªåœºæ™¯Ã—å¤šæ¬¡è¿­ä»£ + åˆ†æžå’ŒæŠ¥å‘Šç”Ÿæˆ
    # - å®žé™…æµ‹è¯•æ—¶é—´ï¼šPRçº¦20ç§’ï¼Œå®Œæ•´æµ‹è¯•çº¦5-10åˆ†é’Ÿ
    timeout-minutes: ${{ github.event_name == 'pull_request' && 5 || 30 }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4.1.1
      with:
        submodules: recursive
    
    - name: Get current date
      id: date
      run: |
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        echo "datetime=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
    
    - name: Setup build environment
      uses: ./.github/actions/setup-build
      with:
        os: ubuntu-latest
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wrk python3 python3-pip
        pip3 install matplotlib numpy
    
    - name: Configure system for performance testing
      run: |
        # è®¾ç½® CPU æ€§èƒ½æ¨¡å¼
        sudo cpupower frequency-set -g performance || true
        
        # ç¦ç”¨ swap
        sudo swapoff -a || true
        
        # å¢žåŠ æœ¬åœ°è¿žæŽ¥é™åˆ¶
        sudo sysctl -w net.core.somaxconn=65535
        sudo sysctl -w net.ipv4.tcp_max_syn_backlog=65535
        sudo sysctl -w net.ipv4.tcp_tw_reuse=1
        
        # å¢žåŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
        ulimit -n 65535
    
    - name: Build project
      run: |
        make build
    
    - name: Run performance tests
      id: performance
      env:
        IS_PR: ${{ github.event_name == 'pull_request' }}
      run: |
        cd build
        if [ -f "./dist/bin/benchmark_rps" ]; then
          chmod +x ./dist/bin/benchmark_rps
          ./dist/bin/benchmark_rps > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          
          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
          for i in {1..10}; do
            if curl -s http://localhost:18081/ > /dev/null 2>&1; then
              echo "Server started"
              break
            fi
            sleep 1
          done
          
          # è¿è¡Œæ€§èƒ½æµ‹è¯•å¹¶æ”¶é›†ç»“æžœ
          echo "=== Performance Test Results ===" > /tmp/performance.log
          
          if [ "$IS_PR" = "true" ]; then
            echo "Running quick performance tests for PR..."
            
            # PR å¿«é€Ÿæµ‹è¯•è¯´æ˜Žï¼š
            # - æµ‹è¯•æ—¶é•¿ï¼š5ç§’ï¼ˆæƒè¡¡é€Ÿåº¦ä¸Žå‡†ç¡®æ€§ï¼Œè¶³å¤Ÿæ£€æµ‹æ€§èƒ½å›žå½’ï¼‰
            # - æµ‹è¯•æ¬¡æ•°ï¼š1æ¬¡ï¼ˆPR å¿«é€ŸéªŒè¯ï¼Œè¯¦ç»†æµ‹è¯•åœ¨å®šæ—¶ä»»åŠ¡ä¸­ï¼‰
            # - æ€»è€—æ—¶ï¼šçº¦15ç§’ï¼ˆ3ä¸ªæµ‹è¯•Ã—5ç§’ + å¯åŠ¨/æ¸…ç†å¼€é”€ï¼‰
            # - ç›®çš„ï¼šå¿«é€ŸéªŒè¯ PR æ˜¯å¦å¼•å…¥æ€§èƒ½å›žå½’
            echo "Test 1: Low concurrency (10 connections, 5 seconds)" >> /tmp/performance.log
            wrk -t2 -c10 -d5s --timeout 5s http://localhost:18081/ >> /tmp/performance.log 2>&1
            
            echo "" >> /tmp/performance.log
            echo "Test 2: Medium concurrency (50 connections, 5 seconds)" >> /tmp/performance.log
            wrk -t4 -c50 -d5s --timeout 5s http://localhost:18081/ >> /tmp/performance.log 2>&1
            
            echo "" >> /tmp/performance.log
            echo "Test 3: High concurrency (100 connections, 5 seconds)" >> /tmp/performance.log
            wrk -t4 -c100 -d5s --timeout 5s http://localhost:18081/ >> /tmp/performance.log 2>&1
          else
            echo "Running full performance benchmark..."
            
            # å®Œæ•´æ€§èƒ½æµ‹è¯•è¯´æ˜Žï¼š
            # - æµ‹è¯•æ—¶é•¿ï¼š30ç§’ï¼ˆæ›´å‡†ç¡®çš„æ€§èƒ½æµ‹é‡ï¼‰
            # - æµ‹è¯•æ¬¡æ•°ï¼š3æ¬¡ï¼ˆå–å¹³å‡å€¼ï¼Œå‡å°‘è¯¯å·®ï¼‰
            # - æµ‹è¯•åœºæ™¯ï¼šä½Ž/ä¸­/é«˜å¹¶å‘
            # - æ€»è€—æ—¶ï¼šçº¦5-10åˆ†é’Ÿ
            # - ç›®çš„ï¼šç”Ÿæˆè¯¦ç»†çš„æ€§èƒ½æŠ¥å‘Šå’Œè¶‹åŠ¿åˆ†æž
            
            for run in 1 2 3; do
              echo "" >> /tmp/performance.log
              echo "=== Run $run ===" >> /tmp/performance.log
              
              echo "Test 1: Low concurrency (10 connections, 30 seconds)" >> /tmp/performance.log
              wrk -t2 -c10 -d30s --timeout 10s http://localhost:18081/ >> /tmp/performance.log 2>&1
              
              echo "" >> /tmp/performance.log
              echo "Test 2: Medium concurrency (50 connections, 30 seconds)" >> /tmp/performance.log
              wrk -t4 -c50 -d30s --timeout 10s http://localhost:18081/ >> /tmp/performance.log 2>&1
              
              echo "" >> /tmp/performance.log
              echo "Test 3: High concurrency (100 connections, 30 seconds)" >> /tmp/performance.log
              wrk -t4 -c100 -d30s --timeout 10s http://localhost:18081/ >> /tmp/performance.log 2>&1
              
              sleep 5  # è®©ç³»ç»Ÿå†·å´
            done
          fi
          
          # åœæ­¢æœåŠ¡å™¨
          kill $SERVER_PID 2>/dev/null || true
          sleep 2
          
          cat /tmp/performance.log
        else
          echo "Error: benchmark_unified not found"
          exit 1
        fi
    
    - name: Parse performance results
      id: parse
      run: |
        # è§£æž wrk è¾“å‡º
        if [ "$IS_PR" = "true" ]; then
          # PR æµ‹è¯•ï¼šè§£æžæœ€åŽä¸€æ¬¡æµ‹è¯•ç»“æžœ
          RPS=$(grep "Requests/sec:" /tmp/performance.log | tail -1 | awk '{print $2}')
          LATENCY_AVG=$(grep "Latency" /tmp/performance.log | tail -2 | head -1 | awk '{print $2}')
        else
          # å®Œæ•´æµ‹è¯•ï¼šè®¡ç®—å¹³å‡å€¼
          RPS_AVG=$(grep "Requests/sec:" /tmp/performance.log | awk '{sum+=$2; count++} END {print sum/count}')
          RPS=$(echo "$RPS_AVG" | awk '{printf "%.2f", $1}')
          LATENCY_AVG=$(grep "Latency" /tmp/performance.log | awk 'NR%4==2 {sum+=$2; count++} END {print sum/count}')
        fi
        
        echo "rps=$RPS" >> $GITHUB_OUTPUT
        echo "latency_avg=$LATENCY_AVG" >> $GITHUB_OUTPUT
    
    - name: Upload performance artifacts
      uses: actions/upload-artifact@v4.3.1
      with:
        name: performance-results-${{ steps.date.outputs.timestamp }}
        path: |
          /tmp/performance.log
          /tmp/server.log
        retention-days: 30
    
    - name: Generate performance summary
      run: |
        echo "## ðŸ“Š Performance Benchmark Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Information" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Date | ${{ steps.date.outputs.datetime }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test Type | ${{ github.event_name == 'pull_request' && 'Quick (PR)' || 'Full (Scheduled)' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Performance Metrics" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Requests/sec | ${{ steps.parse.outputs.rps }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Avg Latency | ${{ steps.parse.outputs.latency_avg }} |" >> $GITHUB_STEP_SUMMARY
