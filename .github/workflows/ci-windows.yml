name: CI/CD Pipeline (Windows)

on:
  push:
    branches: [ main, develop, release, release/*, feature/* ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'

    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cmake --build build --config Release --parallel

    - name: Run fast tests
      run: |
        cd build
        ctest --output-on-failure -j1 --timeout 60 --label-regex "^fast$" --schedule-random --config Release || {
          echo "Fast tests failed or timed out"
          exit 1
        }

    - name: Run death tests
      run: |
        cd build
        if (Test-Path "Release\test_death.exe") {
          .\Release\test_death.exe || {
            echo "Death tests failed"
            exit 1
          }
        } else {
          echo "test_death not found, skipping death tests"
        }

  performance-test:
    runs-on: windows-latest
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'

    - name: Build project with examples
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DBUILD_EXAMPLES=ON
        cmake --build build --config Release --parallel

    - name: Run performance tests
      run: |
        mkdir build\public
        Set-Content -Path "build\public\index.html" -Value "<html><body><h1>Performance Test</h1></body></html>"
        Set-Content -Path "build\public\test.txt" -Value "Test file content"
        cd build
        if (Test-Path "Release\performance_static_server.exe") {
          Start-Process -FilePath ".\Release\performance_static_server.exe" -ArgumentList "-d", ".\public", "-p", "8080" -NoNewWindow -RedirectStandardOutput "server.log" -RedirectStandardError "server_error.log"
          $SERVER_PID = Get-Process | Where-Object { $_.ProcessName -like "*performance_static_server*" }
          
          # 等待服务器启动
          $TIMEOUT = 10
          $COUNT = 0
          while ($COUNT -lt $TIMEOUT) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080/" -UseBasicParsing -TimeoutSec 1
              if ($response.StatusCode -eq 200) {
                echo "Server started successfully"
                break
              }
            } catch {
              # 继续等待
            }
            Start-Sleep -Seconds 1
            $COUNT++
          }
          
          if ($COUNT -eq $TIMEOUT) {
            echo "Server failed to start within $TIMEOUT seconds"
            Stop-Process -Id $SERVER_PID.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }
          
          # 运行性能测试（使用 PowerShell 进行简单的性能测试）
          $RESULTS = @()
          $REQUEST_COUNT = 100
          $CONCURRENT_REQUESTS = 10
          
          echo "Running performance test with $REQUEST_COUNT requests..."
          
          $START_TIME = Get-Date
          
          for ($i = 0; $i -lt $REQUEST_COUNT; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080/" -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                $RESULTS += $true
              } else {
                $RESULTS += $false
              }
            } catch {
              $RESULTS += $false
            }
          }
          
          $END_TIME = Get-Date
          $DURATION = ($END_TIME - $START_TIME).TotalSeconds
          $SUCCESS_COUNT = ($RESULTS | Where-Object { $_ -eq $true }).Count
          $RPS = [math]::Round($SUCCESS_COUNT / $DURATION, 2)
          
          echo "Performance test completed"
          echo "Total requests: $REQUEST_COUNT"
          echo "Successful requests: $SUCCESS_COUNT"
          echo "Duration: $DURATION seconds"
          echo "RPS: $RPS"
          
          if ($SUCCESS_COUNT -lt ($REQUEST_COUNT * 0.9)) {
            echo "Performance test failed: Success rate below 90%"
            Stop-Process -Id $SERVER_PID.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }
          
          # 清理
          Stop-Process -Id $SERVER_PID.Id -Force -ErrorAction SilentlyContinue
        } else {
          echo "performance_static_server not found, skipping performance test"
        }

  stress-test:
    runs-on: windows-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/')

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'

    - name: Build project
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release --parallel

    - name: Run stress tests
      run: |
        cd build
        if (Test-Path "Release\test_stress.exe") {
          .\Release\test_stress.exe || {
            echo "Stress tests failed"
            exit 1
          }
        } else {
          echo "test_stress not found, skipping stress tests"
        }

  code-quality:
    runs-on: windows-latest
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'

    - name: Build project
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Debug
        cmake --build build --config Debug --parallel

    - name: Check for warnings
      run: |
        cmake --build build --config Debug 2>&1 | Select-String "warning" | Select-Object -First 10
        if ($LASTEXITCODE -eq 0) {
          echo "Found compiler warnings!"
          exit 1
        }

  docs-build:
    runs-on: windows-latest
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: docs/package-lock.json

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Install dependencies
      working-directory: ./docs
      run: |
        pnpm install

    - name: Build docs
      working-directory: ./docs
      run: |
        pnpm build

    - name: Verify build output
      working-directory: ./docs
      run: |
        if (-not (Test-Path ".vitepress\dist")) {
          echo "Error: Build output directory not found"
          exit 1
        }
        if (-not (Test-Path ".vitepress\dist\index.html") -and -not (Test-Path ".vitepress\dist\uvhttp\index.html")) {
          echo "Error: index.html not found in build output"
          exit 1
        }
        echo "Docs build verification passed"