name: CI/CD - Performance Tests

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼ˆUTCï¼‰è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'include/**'
      - 'benchmark/**'
      - 'CMakeLists.txt'
  push:
    branches: [ main, develop, pre-release ]
    paths:
      - 'src/**'
      - 'include/**'
      - 'benchmark/**'
      - 'CMakeLists.txt'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  pull-requests: write
  contents: read

jobs:
  performance-benchmark:
    name: Performance Benchmark Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºæ¯”è¾ƒ

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Build and Run Performance Tests
        run: |
          echo "========================================"
          echo "  UVHTTP æ€§èƒ½åŸºå‡†æµ‹è¯•"
          echo "========================================"
          echo ""

          # ä½¿ç”¨ Docker å®¹å™¨éš”ç¦»ç¯å¢ƒ
          docker run --rm --privileged \
            --cpuset-cpus=0-3 \
            --memory=8g \
            --memory-swap=8g \
            --network=host \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:22.04 \
            bash -c "
              set -e
              
              echo '=== å®‰è£…ä¾èµ– ==='
              apt-get update -qq
              apt-get install -y -qq \
                build-essential \
                cmake \
                git \
                wrk \
                apache2-utils \
                linux-tools-common \
                python3 \
                python3-pip \
                python3-yaml
              
              echo '=== ä¼˜åŒ–æµ‹è¯•ç¯å¢ƒ ==='
              # ç¦ç”¨ Swap
              swapoff -a 2>/dev/null || echo 'Swap already disabled'
              
              # GitHub Actions ç¯å¢ƒä¸­æ— æ³•æ§åˆ¶ CPU é¢‘ç‡ï¼Œè·³è¿‡
              echo 'æ³¨æ„: GitHub Actions ç¯å¢ƒä¸­æ— æ³•æ§åˆ¶ CPU é¢‘ç‡'
              
              # éªŒè¯ç¯å¢ƒ
              echo ''
              echo '=== æµ‹è¯•ç¯å¢ƒéªŒè¯ ==='
              echo 'Swap Status:'
              free -h | grep Swap || echo '  (æ— æ³•æ£€æµ‹)'
              echo 'File Descriptors:'
              ulimit -n
              echo 'Available Memory:'
              free -h | grep Mem
              echo ''
              
              # åˆå§‹åŒ–å­æ¨¡å—
              echo '=== åˆå§‹åŒ–å­æ¨¡å— ==='
              git config --global --add safe.directory /workspace
              git submodule update --init --recursive || true
              
              # ç¼–è¯‘é¡¹ç›®
              echo '=== ç¼–è¯‘é¡¹ç›® ==='
              mkdir -p build
              cd build
              # ç¦ç”¨ TLS ä»¥åŠ å¿«ç¼–è¯‘é€Ÿåº¦
              cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_WITH_TLS=OFF ..
              # æ›´æ–°ä¾èµ–å­æ¨¡å—å¹¶ç¼–è¯‘
              make -j\$(nproc) benchmark_rps benchmark_comprehensive
              
              # è¿è¡Œæ€§èƒ½æµ‹è¯•
              echo ''
              echo '=== è¿è¡Œæ€§èƒ½æµ‹è¯• ==='
              cd /workspace/benchmark
              
              # å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
              ../build/dist/bin/benchmark_rps 18081 > /tmp/server.log 2>&1 &
              SERVER_PID=\$!
              
              # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
              sleep 3
              
              # éªŒè¯æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
              if ! kill -0 \$SERVER_PID 2>/dev/null; then
                echo 'ERROR: æœåŠ¡å™¨å¯åŠ¨å¤±è´¥'
                cat /tmp/server.log
                exit 1
              fi
              
              # è¿è¡ŒåŸºå‡†æµ‹è¯•
              echo 'è¿è¡Œä½å¹¶å‘æµ‹è¯•...'
              wrk -t2 -c10 -d10s http://127.0.0.1:18081/ > /tmp/wrk_low.txt 2>&1
              
              echo 'è¿è¡Œä¸­ç­‰å¹¶å‘æµ‹è¯•...'
              wrk -t4 -c50 -d10s http://127.0.0.1:18081/ > /tmp/wrk_medium.txt 2>&1
              
              echo 'è¿è¡Œé«˜å¹¶å‘æµ‹è¯•...'
              wrk -t8 -c200 -d10s http://127.0.0.1:18081/ > /tmp/wrk_high.txt 2>&1
              
              # åœæ­¢æœåŠ¡å™¨
              kill \$SERVER_PID 2>/dev/null || true
              wait \$SERVER_PID 2>/dev/null || true
              
              # æå–ç»“æœ
              echo ''
              echo '=== æµ‹è¯•ç»“æœ ==='
              echo 'ä½å¹¶å‘ RPS:'
              grep 'Requests/sec' /tmp/wrk_low.txt | awk '{print \"  \" \$2}'
              echo 'ä¸­ç­‰å¹¶å‘ RPS:'
              grep 'Requests/sec' /tmp/wrk_medium.txt | awk '{print \"  \" \$2}'
              echo 'é«˜å¹¶å‘ RPS:'
              grep 'Requests/sec' /tmp/wrk_high.txt | awk '{print \"  \" \$2}'
              
              # ç”Ÿæˆ CSV ç»“æœ
              echo ''
              echo '=== ç”Ÿæˆç»“æœæ–‡ä»¶ ==='
              cat > /tmp/results.csv << 'EOF'
              test_name,rps
              low_concurrent,\$(grep 'Requests/sec' /tmp/wrk_low.txt | awk '{print \$2}')
              medium_concurrent,\$(grep 'Requests/sec' /tmp/wrk_medium.txt | awk '{print \$2}')
              high_concurrent,\$(grep 'Requests/sec' /tmp/wrk_high.txt | awk '{print \$2}')
              EOF
              
              cat /tmp/results.csv
            "

      - name: Performance Regression Detection
        if: github.event_name == 'pull_request' || github.event_name == 'push'
        run: |
          echo "=== æ€§èƒ½å›å½’æ£€æµ‹ ==="
          
          # è¿è¡Œå›å½’æ£€æµ‹è„šæœ¬
          python3 scripts/detect_performance_regression.py \
            /tmp/results.csv \
            --baseline config/performance-baseline.yml \
            --output /tmp/regression_report.json \
            --fail-on-regression || EXIT_CODE=$?
          
          # æ˜¾ç¤ºæŠ¥å‘Š
          if [ -f /tmp/regression_report.json ]; then
            cat /tmp/regression_report.json | python3 -m json.tool
          fi
          
          # æ ¹æ®é€€å‡ºç åˆ¤æ–­
          if [ "${EXIT_CODE:-0}" = "1" ]; then
            echo "âŒ æ£€æµ‹åˆ°æ€§èƒ½å›å½’ï¼"
            exit 1
          elif [ "${EXIT_CODE:-0}" = "2" ]; then
            echo "âš ï¸  æ£€æµ‹åˆ°æ€§èƒ½è­¦å‘Š"
            exit 0
          else
            echo "âœ… æ€§èƒ½æ£€æµ‹é€šè¿‡"
          fi

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results-${{ github.run_number }}
          path: |
            /tmp/wrk_*.txt
            /tmp/results.csv
            /tmp/regression_report.json
            /tmp/server.log
          retention-days: 90

      - name: Generate Performance Report
        if: always()
        run: |
          echo "=== æ€§èƒ½æµ‹è¯•æŠ¥å‘Š ==="
          echo ""
          echo "**æµ‹è¯•æ—¶é—´**: $(date -u)"
          echo "**æäº¤**: ${{ github.sha }}"
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}"
          echo ""
          echo "## æµ‹è¯•ç»“æœ"
          echo ""
          if [ -f /tmp/wrk_low.txt ]; then
            echo "### ä½å¹¶å‘æµ‹è¯• (2çº¿ç¨‹ / 10è¿æ¥)"
            grep 'Requests/sec' /tmp/wrk_low.txt | awk '{print "- RPS: " $2}'
            grep 'Latency' /tmp/wrk_low.txt | head -1 | awk '{print "- å¹³å‡å»¶è¿Ÿ: " $2}'
            echo ""
          fi
          if [ -f /tmp/wrk_medium.txt ]; then
            echo "### ä¸­ç­‰å¹¶å‘æµ‹è¯• (4çº¿ç¨‹ / 50è¿æ¥)"
            grep 'Requests/sec' /tmp/wrk_medium.txt | awk '{print "- RPS: " $2}'
            grep 'Latency' /tmp/wrk_medium.txt | head -1 | awk '{print "- å¹³å‡å»¶è¿Ÿ: " $2}'
            echo ""
          fi
          if [ -f /tmp/wrk_high.txt ]; then
            echo "### é«˜å¹¶å‘æµ‹è¯• (8çº¿ç¨‹ / 200è¿æ¥)"
            grep 'Requests/sec' /tmp/wrk_high.txt | awk '{print "- RPS: " $2}'
            grep 'Latency' /tmp/wrk_high.txt | head -1 | awk '{print "- å¹³å‡å»¶è¿Ÿ: " $2}'
            echo ""
          fi
          echo "---"
          echo ""
          echo "å®Œæ•´ç»“æœå·²ä¸Šä¼ åˆ° Artifacts"

      - name: Comment PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ğŸš€ æ€§èƒ½æµ‹è¯•ç»“æœ\n\n';
            comment += `**æµ‹è¯•æ—¶é—´**: ${new Date().toISOString()}\n`;
            comment += `**æäº¤**: ${context.sha.substring(0, 7)}\n\n`;
            
            // è¯»å–ç»“æœæ–‡ä»¶
            try {
              const results = fs.readFileSync('/tmp/results.csv', 'utf8');
              comment += '### æµ‹è¯•ç»“æœ\n\n';
              comment += '```\n' + results + '```\n\n';
            } catch (e) {
              comment += 'âš ï¸  æ— æ³•è¯»å–ç»“æœæ–‡ä»¶\n\n';
            }
            
            // è¯»å–å›å½’æŠ¥å‘Š
            try {
              const report = JSON.parse(fs.readFileSync('/tmp/regression_report.json', 'utf8'));
              const summary = report.summary;
              
              comment += '### å›å½’æ£€æµ‹\n\n';
              if (summary.has_regression) {
                comment += `âŒ **æ£€æµ‹åˆ° ${summary.total_regressions} ä¸ªæ€§èƒ½å›å½’**\n\n`;
              } else if (summary.has_warning) {
                comment += `âš ï¸  **æ£€æµ‹åˆ° ${summary.total_warnings} ä¸ªæ€§èƒ½è­¦å‘Š**\n\n`;
              } else {
                comment += 'âœ… **æœªæ£€æµ‹åˆ°æ€§èƒ½å›å½’**\n\n';
              }
              
              if (summary.has_improvement) {
                comment += `ğŸ‰ **æ£€æµ‹åˆ° ${summary.total_improvements} ä¸ªæ€§èƒ½æ”¹è¿›**\n\n`;
              }
            } catch (e) {
              comment += 'âš ï¸  æ— æ³•è¯»å–å›å½’æŠ¥å‘Š\n\n';
            }
            
            comment += '---\n\n';
            comment += 'ğŸ“Š å®Œæ•´ç»“æœ: [ä¸‹è½½ Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n';
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## ğŸš€ æ€§èƒ½æµ‹è¯•ç»“æœ')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  database-simulation:
    name: Database Query Simulation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Test
        run: |
          docker run --rm --privileged \
            --cpuset-cpus=0-3 \
            --memory=4g \
            --network=host \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:22.04 \
            bash -c "
              apt-get update -qq && apt-get install -y -qq build-essential cmake wrk linux-tools-common git
              swapoff -a 2>/dev/null || true
              
              # åˆå§‹åŒ–å­æ¨¡å—
              git config --global --add safe.directory /workspace
              git submodule update --init --recursive || true
              
              mkdir -p build && cd build
              cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_WITH_TLS=OFF ..
              make -j\$(nproc) benchmark_database_simulation
              
              # å¯åŠ¨æ•°æ®åº“æ¨¡æ‹ŸæœåŠ¡å™¨
              ../build/dist/bin/benchmark_database_simulation > /tmp/db_server.log 2>&1 &
              DB_PID=\$!
              sleep 3
              
              # æµ‹è¯•å¿«é€ŸæŸ¥è¯¢
              echo '=== å¿«é€ŸæŸ¥è¯¢æµ‹è¯• ==='
              wrk -t4 -c50 -d10s http://127.0.0.1:18085/api/fast
              
              # æµ‹è¯•æ··åˆæŸ¥è¯¢
              echo '=== æ··åˆæŸ¥è¯¢æµ‹è¯• ==='
              wrk -t4 -c50 -d10s http://127.0.0.1:18085/api/mixed
              
              kill \$DB_PID 2>/dev/null || true
            "

  file-upload-test:
    name: File Upload Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and Test
        run: |
          docker run --rm --privileged \
            --cpuset-cpus=0-3 \
            --memory=4g \
            --network=host \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:22.04 \
            bash -c "
              apt-get update -qq && apt-get install -y -qq build-essential cmake curl linux-tools-common git
              swapoff -a 2>/dev/null || true
              
              # åˆå§‹åŒ–å­æ¨¡å—
              git config --global --add safe.directory /workspace
              git submodule update --init --recursive || true
              
              mkdir -p build && cd build
              cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_WITH_TLS=OFF ..
              make -j\$(nproc) benchmark_file_upload
              
              # å¯åŠ¨æ–‡ä»¶ä¸Šä¼ æœåŠ¡å™¨
              ../build/dist/bin/benchmark_file_upload > /tmp/upload_server.log 2>&1 &
              UPLOAD_PID=\$!
              sleep 3
              
              # æµ‹è¯•å¥åº·æ£€æŸ¥
              echo '=== å¥åº·æ£€æŸ¥ ==='
              curl -s http://127.0.0.1:18086/health
              
              # æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
              echo '=== æ–‡ä»¶ä¸Šä¼ æµ‹è¯• ==='
              echo 'test data' | curl -X POST -F 'file=@-' http://127.0.0.1:18086/upload
              
              kill \$UPLOAD_PID 2>/dev/null || true
            "