name: CI/CD - Push Full Validation

# è§¦å‘æ¡ä»¶ï¼šPush åˆ° mainã€developã€feature/* åˆ†æ”¯
on:
  push:
    branches: [ main, develop, 'feature/**' ]
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šå–æ¶ˆåŒä¸€åˆ†æ”¯çš„æ—§è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  TEST_TYPE: full

jobs:
  # ========== é˜¶æ®µ 1: å¹¶è¡Œæ„å»ºå’Œæ‰«æ ==========
  
  ubuntu-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      build-dir: ${{ steps.build.outputs.build-dir }}
      build-status: ${{ steps.build.outputs.status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: push-${{ github.sha }}
          build-type: Release
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_WITH_WEBSOCKET=ON \
            -DBUILD_WITH_MIMALLOC=ON
      
      - name: Build
        id: build
        run: |
          cmake --build build --config Release -j$(nproc)
          echo "build-dir=build" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-ubuntu-push-${{ github.sha }}
          path: build/
          retention-days: 7
  
  macos-build:
    runs-on: macos-latest
    timeout-minutes: 25
    outputs:
      build-status: ${{ steps.build.outputs.status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: macos-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: push-${{ github.sha }}
          build-type: Release
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_WITH_WEBSOCKET=ON \
            -DBUILD_WITH_MIMALLOC=ON
      
      - name: Build
        id: build
        run: |
          cmake --build build --config Release -j$(sysctl -n hw.ncpu)
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-macos-push-${{ github.sha }}
          path: build/
          retention-days: 7
  
  windows-build:
    runs-on: windows-latest
    timeout-minutes: 30
    outputs:
      build-status: ${{ steps.build.outputs.status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: windows-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: push-${{ github.sha }}
          build-type: Release
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_WITH_WEBSOCKET=ON `
            -DBUILD_WITH_MIMALLOC=ON
      
      - name: Build
        id: build
        run: |
          cmake --build build --config Release -j
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-push-${{ github.sha }}
          path: build/
          retention-days: 7
  
  code-quality-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --xml --xml-version=2 \
            src/ include/ 2> cppcheck-results.xml || true
      
      - name: Upload cppcheck results
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-results-push-${{ github.sha }}
          path: cppcheck-results.xml
          retention-days: 7
  
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Run security scan
        run: |
          # è¿™é‡Œå¯ä»¥é›†æˆå…¶ä»–å®‰å…¨æ‰«æå·¥å…·
          echo "Security scan completed"
  
  # ========== é˜¶æ®µ 2: å¹¶è¡Œæµ‹è¯• ==========
  
  ubuntu-test-full:
    needs: [ubuntu-build]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-push-${{ github.sha }}
          path: build/
      
      - name: Run full tests
        run: |
          cd build
          ctest --output-on-failure -j$(nproc) --timeout 120
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-ubuntu-push-${{ github.sha }}
          path: build/Testing/
          retention-days: 7
  
  macos-test-full:
    needs: [macos-build]
    runs-on: macos-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-macos-push-${{ github.sha }}
          path: build/
      
      - name: Run full tests
        run: |
          cd build
          ctest --output-on-failure -j$(sysctl -n hw.ncpu) --timeout 120
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-macos-push-${{ github.sha }}
          path: build/Testing/
          retention-days: 7
  
  windows-test-full:
    needs: [windows-build]
    runs-on: windows-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-windows-push-${{ github.sha }}
          path: build/
      
      - name: Run full tests
        run: |
          cd build
          ctest --output-on-failure -j --timeout 120
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-windows-push-${{ github.sha }}
          path: build/Testing/
          retention-days: 7
  
  # ========== é˜¶æ®µ 3: æ€§èƒ½åŸºå‡†æµ‹è¯• ==========
  
  performance-benchmark:
    needs: [ubuntu-test-full]
    runs-on: ubuntu-latest
    timeout-minutes: 35
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-push-${{ github.sha }}
          path: build/
      
      - name: Install wrk
        run: |
          sudo apt-get update
          sudo apt-get install -y wrk python3 python3-pip
          pip3 install matplotlib numpy
      
      - name: Run performance tests
        run: |
          chmod +x build/dist/bin/performance_static_server
          mkdir -p build/public
          echo "<html><body><h1>Performance Test</h1></body></html>" > build/public/index.html
          
          # ä½å¹¶å‘æµ‹è¯•
          build/dist/bin/performance_static_server -d build/public -p 8080 > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          sleep 3
          
          wrk -t4 -c10 -d5s --timeout 5s http://localhost:8080/ > performance.log
          kill $SERVER_PID 2>/dev/null || true
      
      - name: Parse performance results
        id: parse
        run: |
          # è§£æ wrk è¾“å‡º
          RPS=$(grep "Requests/sec:" performance.log | awk '{print $2}')
          LATENCY_AVG=$(grep "Latency" performance.log | awk 'NR==2 {print $2}')
          
          echo "rps=$RPS" >> $GITHUB_OUTPUT
          echo "latency_avg=$LATENCY_AVG" >> $GITHUB_OUTPUT
      
      - name: Generate performance report
        run: |
          cat > performance-report.md << 'EOF'
          # Performance Benchmark Report
          
          - **Date**: ${{ github.event.head_commit.timestamp }}
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          
          ## Results
          
          | Metric | Value |
          |--------|-------|
          | Requests/sec | ${{ steps.parse.outputs.rps }} |
          | Avg Latency | ${{ steps.parse.outputs.latency_avg }} |
          
          EOF
      
      - name: Update baseline history
        run: |
          HISTORY_FILE="baseline-history.json"
          
          if [ ! -f "$HISTORY_FILE" ]; then
            echo '[]' > "$HISTORY_FILE"
          fi
          
          jq --argjson current "$(cat performance-results.json)" '. + [$current] | .[:30]' "$HISTORY_FILE" > "${HISTORY_FILE}.tmp" && mv "${HISTORY_FILE}.tmp" "$HISTORY_FILE"
      
      - name: Upload performance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-results-push-${{ github.sha }}
          path: |
            performance-report.md
            performance.log
            baseline-history.json
          retention-days: 30
  
  # ========== é˜¶æ®µ 4: ç”Ÿæˆæ€»ç»“ ==========
  
  generate-summary:
    needs: [ubuntu-test-full, macos-test-full, windows-test-full, performance-benchmark]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ğŸ“Š CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu | ${{ needs.ubuntu-test-full.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.macos-test-full.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.windows-test-full.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Requests/sec | ${{ needs.performance-benchmark.outputs.rps || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY