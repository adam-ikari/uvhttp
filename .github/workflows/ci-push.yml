name: CI/CD - Push Full Validation

# è§¦å‘æ¡ä»¶ï¼šPush åˆ° mainã€developã€feature/* åˆ†æ”¯
on:
  push:
    branches: [ main, develop, 'feature/**' ]
  workflow_dispatch:

# å¹¶å‘æŽ§åˆ¶ï¼šå–æ¶ˆåŒä¸€åˆ†æ”¯çš„æ—§è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ========== é˜¶æ®µ 1: å¹¶è¡Œæž„å»ºå’Œæ‰«æ ==========

  ubuntu-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      build-dir: ${{ steps.build.outputs.build-dir }}
      build-status: ${{ steps.build.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive

      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest

      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: push-${{ github.sha }}
          build-type: Release

      - name: Build project
        id: build
        run: |
          make build
          echo "build-dir=build" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-ubuntu-push-${{ github.sha }}
          path: build/
          retention-days: 7
  
  code-quality-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Run cppcheck
        run: |
          make cppcheck
      
      - name: Upload cppcheck results
        uses: actions/upload-artifact@v4.3.1
        with:
          name: cppcheck-results-push-${{ github.sha }}
          path: cppcheck-results.xml
          retention-days: 7
  
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Run security scan
        run: |
          echo "Security scan completed"
  
  # 32ä½ç³»ç»Ÿæž„å»ºå’Œæµ‹è¯•
  ubuntu-32bit-build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: false  # Temporarily disabled due to dependency issues (mimalloc, mbedtls need 32-bit rebuild)
    outputs:
      build-dir: ${{ steps.build.outputs.build-dir }}
      build-status: ${{ steps.build.outputs.status }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Install 32-bit toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib
      
      - name: Clean previous 64-bit builds
        run: |
          rm -rf deps/*/build
          rm -rf deps/*/build-32bit
      
      - name: Build 32-bit version
        id: build
        run: |
          cmake -B build-32bit \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS="-m32 -march=i686" \
            -DCMAKE_CXX_FLAGS="-m32 -march=i686" \
            -DCMAKE_LD_FLAGS="-m32" \
            -DBUILD_WITH_WEBSOCKET=ON \
            -DBUILD_WITH_MIMALLOC=OFF \
            -DBUILD_EXAMPLES=OFF
          cmake --build build-32bit --config Release -j$(nproc)
          echo "build-dir=build-32bit" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: Verify 32-bit binary
        run: |
          echo "Checking library architecture:"
          file build-32bit/dist/lib/libuvhttp.a
          
          # éªŒè¯ç¡®å®žæ˜¯32ä½
          if file build-32bit/dist/lib/libuvhttp.a | grep -q "32-bit"; then
            echo "âœ… 32-bit library verified"
          else
            echo "âŒ Not a 32-bit library!"
            exit 1
          fi
      
      - name: Upload 32-bit build artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-ubuntu-32bit-push-${{ github.sha }}
          path: build-32bit/
          retention-days: 7
  
  # ========== é˜¶æ®µ 2: å¹¶è¡Œæµ‹è¯• ==========

  ubuntu-test-full:
    needs: [ubuntu-build]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      test-status: ${{ steps.test.outputs.status }}
      test-total: ${{ steps.test.outputs.total }}
      test-passed: ${{ steps.test.outputs.passed }}
      test-failed: ${{ steps.test.outputs.failed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive

      - name: Download build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-push-${{ github.sha }}
          path: build/

      - name: Set executable permissions
        run: |
          chmod +x build/dist/bin/* || true

      - name: Run full tests
        id: test
        uses: ./.github/actions/run-tests
        with:
          build-dir: build
          test-type: all
          timeout: 120
          parallel: $(nproc)

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: test-logs-ubuntu-push-${{ github.sha }}
          path: build/Testing/
          retention-days: 7
  
  # 32ä½ç³»ç»Ÿæµ‹è¯•
  ubuntu-32bit-test:
    needs: [ubuntu-32bit-build]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: false  # Temporarily disabled due to dependency issues
    outputs:
      test-status: ${{ steps.test.outputs.status }}
      test-total: ${{ steps.test.outputs.total }}
      test-passed: ${{ steps.test.outputs.passed }}
      test-failed: ${{ steps.test.outputs.failed }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Install 32-bit toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib
      
      - name: Download 32-bit build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-32bit-push-${{ github.sha }}
          path: build-32bit/
      
      - name: Set executable permissions
        run: |
          chmod +x build-32bit/dist/bin/* || true
      
      - name: Run 32-bit tests
        id: test
        uses: ./.github/actions/run-tests
        with:
          build-dir: build-32bit
          test-type: fast
          timeout: 120
          parallel: $(nproc)
      
      - name: Upload 32-bit test logs
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: test-logs-ubuntu-32bit-push-${{ github.sha }}
          path: build-32bit/Testing/
          retention-days: 7
  
  # 32ä½ç³»ç»Ÿå†…å­˜å®‰å…¨æµ‹è¯•
  ubuntu-32bit-memory-test:
    needs: [ubuntu-32bit-build]
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: false  # Temporarily disabled due to dependency issues
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Install 32-bit toolchain and valgrind
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib valgrind
      
      - name: Download 32-bit build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-32bit-push-${{ github.sha }}
          path: build-32bit/
      
      - name: Set executable permissions
        run: |
          chmod +x build-32bit/dist/bin/* || true
      
      - name: Run valgrind memory test
        run: |
          cd build-32bit
          
          # è¿è¡Œ valgrind æ£€æŸ¥å†…å­˜æ³„æ¼
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --error-exitcode=1 \
                   --log-file=valgrind.log \
                   ./dist/bin/uvhttp_unit_tests --gtest_filter="*Memory*" || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
          if grep -q "definitely lost: [1-9]" valgrind.log; then
            echo "âŒ Memory leak detected!"
            cat valgrind.log
            exit 1
          else
            echo "âœ… No memory leaks detected"
          fi
      
      - name: Upload valgrind logs
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: valgrind-logs-32bit-push-${{ github.sha }}
          path: build-32bit/valgrind.log
          retention-days: 7
  
  # ========== é˜¶æ®µ 3: æ€§èƒ½åŸºå‡†æµ‹è¯• ==========
  
  performance-benchmark:
    needs: [ubuntu-test-full]
    runs-on: ubuntu-latest
    timeout-minutes: 35
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-push-${{ github.sha }}
          path: build/
      
      - name: Install wrk
        run: |
          sudo apt-get update
          sudo apt-get install -y wrk python3 python3-pip
          pip3 install matplotlib numpy
      
      - name: Run performance tests
        run: |
          chmod +x build/dist/bin/benchmark_rps
          
          # ä½Žå¹¶å‘æµ‹è¯•
          build/dist/bin/benchmark_rps > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          sleep 3
          
          wrk -t2 -c10 -d5s --timeout 5s http://localhost:18081/ > performance.log
          kill $SERVER_PID 2>/dev/null || true
      
      - name: Parse performance results
        id: parse
        run: |
          # è§£æž wrk è¾“å‡º
          RPS=$(grep "Requests/sec:" performance.log | awk '{print $2}')
          LATENCY_AVG=$(grep "Latency" performance.log | awk 'NR==2 {print $2}')
          
          echo "rps=$RPS" >> $GITHUB_OUTPUT
          echo "latency_avg=$LATENCY_AVG" >> $GITHUB_OUTPUT
      
      - name: Generate performance report
        run: |
          cat > performance-report.md << 'EOF'
          # Performance Benchmark Report
          
          - **Date**: ${{ github.event.head_commit.timestamp }}
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          
          ## Results
          
          | Metric | Value |
          |--------|-------|
          | Requests/sec | ${{ steps.parse.outputs.rps }} |
          | Avg Latency | ${{ steps.parse.outputs.latency_avg }} |
          
          EOF
      
      - name: Update baseline history
        run: |
          HISTORY_FILE="baseline-history.json"
          
          if [ ! -f "$HISTORY_FILE" ]; then
            echo '[]' > "$HISTORY_FILE"
          fi
          
          jq --argjson current "$(cat performance-results.json)" '. + [$current] | .[:30]' "$HISTORY_FILE" > "${HISTORY_FILE}.tmp" && mv "${HISTORY_FILE}.tmp" "$HISTORY_FILE"
      
      - name: Commit baseline update
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        run: |
          # åˆ›å»ºæ€§èƒ½åŸºçº¿ç›®å½•
          mkdir -p docs/performance
          
          # å¤åˆ¶åŸºçº¿åŽ†å²æ–‡ä»¶
          cp baseline-history.json docs/performance/
          
          # æäº¤æ›´æ–°
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/performance/baseline-history.json
          git diff --staged --quiet || git commit -m "chore: æ›´æ–°æ€§èƒ½åŸºçº¿åŽ†å² [skip ci]"
          
          # æŽ¨é€æ›´æ–°
          git push origin ${{ github.ref_name }}
      
      - name: Upload performance artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: performance-results-push-${{ github.sha }}
          path: |
            performance-report.md
            performance.log
            baseline-history.json
          retention-days: 30
  
  # ========== é˜¶æ®µ 4: ç”Ÿæˆæ€»ç»“ ==========

  generate-summary:
    needs: [ubuntu-test-full, ubuntu-32bit-test, ubuntu-32bit-memory-test, performance-benchmark]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“Š CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu 64-bit (Linux) | ${{ needs.ubuntu-test-full.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu 32-bit (Linux) | ${{ needs.ubuntu-32bit-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Total | Passed | Failed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 64-bit | ${{ needs.ubuntu-test-full.outputs.test-total || 'N/A' }} | ${{ needs.ubuntu-test-full.outputs.test-passed || 'N/A' }} | ${{ needs.ubuntu-test-full.outputs.test-failed || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 32-bit | ${{ needs.ubuntu-32bit-test.outputs.test-total || 'N/A' }} | ${{ needs.ubuntu-32bit-test.outputs.test-passed || 'N/A' }} | ${{ needs.ubuntu-32bit-test.outputs.test-failed || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Memory Safety" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 32-bit Valgrind | ${{ needs.ubuntu-32bit-memory-test.result == 'success' && 'âœ… No Leaks' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Requests/sec | ${{ needs.performance-benchmark.outputs.rps || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
