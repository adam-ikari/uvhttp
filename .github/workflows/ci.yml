name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, release, release/*, feature/* ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # 条件判断统一化
  IS_MAIN: ${{ github.ref == 'refs/heads/main' }}
  IS_DEVELOP: ${{ github.ref == 'refs/heads/develop' }}
  IS_RELEASE: ${{ startsWith(github.ref, 'refs/heads/release/') }}
  IS_FEATURE: ${{ startsWith(github.ref, 'refs/heads/feature/') }}
  IS_PR: ${{ github.event_name == 'pull_request' }}
  
  # 组合条件
  RUN_PERF: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/') }}
  RUN_STRESS: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') }}
  RUN_MEMORY: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') }}

jobs:
  # ========== Ubuntu Build & Test ==========
  ubuntu-build:
    uses: ./.github/workflows/reusable/build.yml
    with:
      os: ubuntu-latest
      build-type: Release
      cache-key: ${{ github.sha }}
  
  ubuntu-test-fast:
    needs: ubuntu-build
    uses: ./.github/workflows/reusable/test.yml
    with:
      os: ubuntu-latest
      build-type: Release
      test-type: fast
      timeout: 60
      parallel: 1
  
  ubuntu-security:
    uses: ./.github/workflows/reusable/security.yml
    with:
      scan-type: all
  
  ubuntu-performance:
    needs: ubuntu-build
    if: env.RUN_PERF == 'true'
    uses: ./.github/workflows/reusable/build.yml
    with:
      os: ubuntu-latest
      build-type: Release
      enable-examples: true
      cache-key: ${{ github.sha }}-examples
  
  ubuntu-performance-run:
    needs: ubuntu-performance
    if: env.RUN_PERF == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-latest-Release
      - name: Run performance test
        run: |
          mkdir -p build-release/public
          echo "<html><body><h1>Performance Test</h1></body></html>" > build-release/public/index.html
          cd build-release
          if [ -f "./dist/bin/performance_static_server" ]; then
            ./dist/bin/performance_static_server -d ./public -p 8080 > /tmp/server.log 2>&1 &
            SERVER_PID=$!
            sleep 3
            wrk -t4 -c100 -d10s --timeout 5s http://localhost:8080/
            WRK_EXIT=$?
            kill $SERVER_PID 2>/dev/null || true
            exit $WRK_EXIT
          fi
  
  # ========== macOS Build & Test ==========
  macos-build:
    uses: ./.github/workflows/reusable/build.yml
    with:
      os: macos-latest
      build-type: Release
      cache-key: ${{ github.sha }}
  
  macos-test-fast:
    needs: macos-build
    uses: ./.github/workflows/reusable/test.yml
    with:
      os: macos-latest
      build-type: Release
      test-type: fast
      timeout: 60
  
  # ========== Windows Build & Test ==========
  windows-build:
    uses: ./.github/workflows/reusable/build.yml
    with:
      os: windows-latest
      build-type: Release
      cache-key: ${{ github.sha }}
  
  windows-test-fast:
    needs: windows-build
    uses: ./.github/workflows/reusable/test.yml
    with:
      os: windows-latest
      build-type: Release
      test-type: fast
      timeout: 60
  
  # ========== Docs Build ==========
  docs-build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: env.RUN_PERF == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Build docs
        working-directory: ./docs
        run: |
          pnpm install
          pnpm build
      - name: Verify build output
        working-directory: ./docs
        run: |
          if [ ! -d ".vitepress/dist" ]; then
            echo "Error: Build output directory not found"
            exit 1
          fi
          if [ -f ".vitepress/dist/index.html" ]; then
            echo "Docs build verification passed (index.html in root)"
          elif [ -f ".vitepress/dist/uvhttp/index.html" ]; then
            echo "Docs build verification passed (index.html in uvhttp/)"
          else
            echo "Error: index.html not found in build output"
            exit 1
          fi