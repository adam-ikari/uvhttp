name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, release, release/*, feature/* ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # 条件判断统一化
  IS_MAIN: ${{ github.ref == 'refs/heads/main' }}
  IS_DEVELOP: ${{ github.ref == 'refs/heads/develop' }}
  IS_RELEASE: ${{ startsWith(github.ref, 'refs/heads/release/') }}
  IS_FEATURE: ${{ startsWith(github.ref, 'refs/heads/feature/') }}
  IS_PR: ${{ github.event_name == 'pull_request' }}

jobs:
  # ========== Ubuntu Build & Test ==========
  ubuntu-build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential valgrind wrk lcov

      - name: Configure CMake
        run: |
          cmake -B build-release -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build-release --config Release -j$(nproc)

      - name: Check for warnings
        run: |
          if cmake --build build-release --config Release 2>&1 | grep -i "warning:"; then
            echo "Found compiler warnings!"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-ubuntu-latest-Release
          path: build-release/dist/
          retention-days: 7

  ubuntu-test-fast:
    needs: ubuntu-build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-latest-Release
          path: build-release

      - name: Run fast tests
        run: |
          cd build-release
          ctest --output-on-failure -j1 --timeout 60 --schedule-random

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-ubuntu-fast
          path: |
            build-release/Testing/
            build-release/**/*.log
          retention-days: 7

  ubuntu-security:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,performance,portability \
            --error-exitcode=0 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=constParameter \
            --suppress=unusedStructMember \
            --xml \
            -DUVHTTP_STRINGIFY\(x\)=\#x \
            -DUVHTTP_FEATURE_WEBSOCKET=1 \
            -DUVHTTP_FEATURE_STATIC_FILES=1 \
            -DUVHTTP_FEATURE_TLS=1 \
            -DUVHTTP_FEATURE_RATE_LIMIT=1 \
            -DUVHTTP_FEATURE_LOGGING=1 \
            -DUVHTTP_FEATURE_LRU_CACHE=1 \
            -DUVHTTP_FEATURE_ROUTER_CACHE=1 \
            src/ 2> cppcheck.xml || true

      - name: Upload cppcheck results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-results
          path: cppcheck.xml
          retention-days: 7

  ubuntu-performance:
    needs: ubuntu-build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Configure CMake with examples
        run: |
          cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DBUILD_EXAMPLES=ON

      - name: Build with examples
        run: |
          cmake --build build-release --config Release -j$(nproc)

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-ubuntu-latest-Release
          path: build-release/dist/
          retention-days: 7

  ubuntu-performance-run:
    needs: ubuntu-performance
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-latest-Release

      - name: Run performance test
        run: |
          mkdir -p build-release/public
          echo "<html><body><h1>Performance Test</h1></body></html>" > build-release/public/index.html
          cd build-release
          if [ -f "./dist/bin/performance_static_server" ]; then
            ./dist/bin/performance_static_server -d ./public -p 8080 > /tmp/server.log 2>&1 &
            SERVER_PID=$!
            sleep 3
            wrk -t4 -c100 -d10s --timeout 5s http://localhost:8080/
            WRK_EXIT=$?
            kill $SERVER_PID 2>/dev/null || true
            exit $WRK_EXIT
          fi

  # ========== Docs Build ==========
  docs-build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Build docs
        working-directory: ./docs
        run: |
          rm -rf node_modules .vitepress/.temp
          pnpm install --force
          pnpm build

      - name: Verify build output
        working-directory: ./docs
        run: |
          if [ ! -d ".vitepress/dist" ]; then
            echo "Error: Build output directory not found"
            exit 1
          fi
          if [ -f ".vitepress/dist/index.html" ]; then
            echo "Docs build verification passed (index.html in root)"
          elif [ -f ".vitepress/dist/uvhttp/index.html" ]; then
            echo "Docs build verification passed (index.html in uvhttp/)"
          else
            echo "Error: index.html not found in build output"
            exit 1
          fi