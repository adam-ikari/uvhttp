name: CI/CD - Build & Test Pipeline

on:
  push:
    branches: [ main, develop, release, release/*, feature/* ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # 条件判断统一化
  IS_MAIN: ${{ github.ref == 'refs/heads/main' }}
  IS_DEVELOP: ${{ github.ref == 'refs/heads/develop' }}
  IS_RELEASE: ${{ startsWith(github.ref, 'refs/heads/release/') }}
  IS_FEATURE: ${{ startsWith(github.ref, 'refs/heads/feature/') }}
  IS_PR: ${{ github.event_name == 'pull_request' }}

jobs:
  # ========== Ubuntu Build & Test ==========
  ubuntu-build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive

      - name: Setup CMake
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential valgrind wrk lcov

      - name: Configure CMake
        run: |
          cmake -B build-release -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build-release --config Release -j$(nproc)

      - name: Check for warnings
        run: |
          if cmake --build build-release --config Release 2>&1 | grep -i "warning:"; then
            echo "Found compiler warnings!"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-ubuntu-latest-Release
          path: build-release/dist/
          retention-days: 7

  ubuntu-test-fast:
    needs: ubuntu-build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive

      - name: Download build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-latest-Release
          path: build-release

      - name: Run fast tests
        run: |
          cd build-release
          ctest --output-on-failure -j1 --timeout 60 --schedule-random

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: test-logs-ubuntu-fast
          path: |
            build-release/Testing/
            build-release/**/*.log
          retention-days: 7

  ubuntu-security:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,performance,portability \
            --error-exitcode=1 \
            --max-configs=1 \
            --inconclusive \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=constParameter \
            --suppress=unusedStructMember \
            --xml \
            -DUVHTTP_STRINGIFY\(x\)=\#x \
            -DUVHTTP_FEATURE_WEBSOCKET=1 \
            -DUVHTTP_FEATURE_STATIC_FILES=1 \
            -DUVHTTP_FEATURE_TLS=1 \
            -DUVHTTP_FEATURE_RATE_LIMIT=1 \
            -DUVHTTP_FEATURE_LOGGING=1 \
            -DUVHTTP_FEATURE_LRU_CACHE=1 \
            -DUVHTTP_FEATURE_ROUTER_CACHE=1 \
            src/ 2> cppcheck.xml || {
              # 检查错误数量
              ERROR_COUNT=$(grep -c '<error' cppcheck.xml 2>/dev/null || echo "0")
              echo "Found $ERROR_COUNT cppcheck errors"
              
              # 设置阈值：任何错误都失败
              if [ "$ERROR_COUNT" -gt 0 ]; then
                echo "Found $ERROR_COUNT cppcheck errors, failing build"
                exit 1
              else
                echo "No cppcheck errors found"
                exit 0
              fi
            }

      - name: Upload cppcheck results
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: cppcheck-results
          path: cppcheck.xml
          retention-days: 7

  
