name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, release/*, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TIMEOUT_MINUTES: 15
  CACHE_VERSION: v1

jobs:
  # 快速构建和测试 - 在所有分支和 PR 中运行
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04]
        compiler: [gcc]

    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ env.TIMEOUT_MINUTES }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Cache apt packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: cmake build-essential
        version: ubuntu-22.04

    - name: Cache ccache
      uses: actions/cache@v3
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Cache CMake build
      uses: actions/cache@v3
      with:
        path: |
          build
          build-*
        key: ${{ runner.os }}-cmake-${{ env.CACHE_VERSION }}-${{ hashFiles('**/CMakeLists.txt', '**/*.c', '**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-cmake-${{ env.CACHE_VERSION }}-

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_EXAMPLES=OFF

    - name: Build
      run: |
        cmake --build build --config Release -j$(nproc)

    - name: Run fast tests
      run: |
        cd build
        ctest --output-on-failure -j$(nproc) --timeout 60 \
          --label-regex "^fast$" --schedule-random

    - name: Check for warnings
      run: |
        if cmake --build build --config Release 2>&1 | grep -i "warning:"; then
          echo "Found compiler warnings!"
          exit 1
        fi

  # 代码质量检查 - 在 main/develop 和 PR 中运行
  code-quality:
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Cache apt packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: cmake build-essential cppcheck lcov
        version: ubuntu-22.04

    - name: Cache CMake build
      uses: actions/cache@v3
      with:
        path: |
          build
          build-*
        key: ${{ runner.os }}-cmake-${{ env.CACHE_VERSION }}-${{ hashFiles('**/CMakeLists.txt', '**/*.c', '**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-cmake-${{ env.CACHE_VERSION }}-

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug

    - name: Build
      run: |
        cmake --build build --config Debug -j$(nproc)

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,performance,portability --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=constParameter \
          --suppress=unusedStructMember \
          -DUVHTTP_STRINGIFY\(x\)=\#x \
          -DUVHTTP_FEATURE_WEBSOCKET=1 \
          -DUVHTTP_FEATURE_STATIC_FILES=1 \
          -DUVHTTP_FEATURE_TLS=1 \
          -DUVHTTP_FEATURE_RATE_LIMIT=1 \
          -DUVHTTP_FEATURE_LOGGING=1 \
          -DUVHTTP_FEATURE_LRU_CACHE=1 \
          -DUVHTTP_FEATURE_ROUTER_CACHE=1 \
          -DUVHTTP_ENABLE_ROUTER_CACHE_OPTIMIZATION=1 \
          -DUVHTTP_ROUTER_SEARCH_MODE=2 \
          src/

  # 文档构建测试 - 在所有分支和 PR 中运行
  docs-build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'pull_request' || startsWith(github.ref, 'refs/heads/feature/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: docs/package-lock.json

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Install dependencies
      working-directory: ./docs
      run: |
        pnpm install

    - name: Build docs
      working-directory: ./docs
      run: |
        pnpm build

    - name: Verify build output
      working-directory: ./docs
      run: |
        if [ ! -d ".vitepress/dist" ]; then
          echo "Error: Build output directory not found"
          exit 1
        fi
        if [ -f ".vitepress/dist/index.html" ]; then
          echo "Docs build verification passed (index.html in root)"
        elif [ -f ".vitepress/dist/uvhttp/index.html" ]; then
          echo "Docs build verification passed (index.html in uvhttp/)"
        else
          echo "Error: index.html not found in build output"
          echo "Contents of dist directory:"
          ls -la .vitepress/dist/
          exit 1
        fi

    - name: Check for broken links
      working-directory: ./docs
      run: |
        pnpm build 2>&1 | grep -i "dead link\|broken link" && {
          echo "Found broken links in documentation"
          exit 1
        } || echo "No broken links found"