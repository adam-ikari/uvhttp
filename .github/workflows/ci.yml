name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, release/*, feature/* ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cmake --build build --config Release -j$(nproc)

    - name: Run fast tests
      run: |
        cd build
        # 运行所有快速测试
        ctest --output-on-failure -j1 --timeout 300 --schedule-random || {
          echo "Fast tests failed or timed out"
          exit 1
        }

    - name: Check for warnings
      run: |
        if cmake --build build --config Release 2>&1 | grep -i "warning:"; then
          echo "Found compiler warnings!"
          exit 1
        fi

  

  # 性能测试只在 main 分支和 PR 中运行
  performance-test:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential wrk

    - name: Build project with examples
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_EXAMPLES=ON
        cmake --build build --config Release -j$(nproc)

    - name: Run performance tests
      run: |
        mkdir -p build/public
        echo "<html><body><h1>Performance Test</h1></body></html>" > build/public/index.html
        echo "Test file content" > build/public/test.txt
        cd build
        if [ -f "./dist/bin/performance_static_server" ]; then
          ./dist/bin/performance_static_server -d ./public -p 8080 &
          SERVER_PID=$!
          
          # 等待服务器启动，最多等待 10 秒
          TIMEOUT=10
          COUNT=0
          while [ $COUNT -lt $TIMEOUT ]; do
            if curl -s http://localhost:8080/ > /dev/null 2>&1; then
              echo "Server started successfully"
              break
            fi
            sleep 1
            COUNT=$((COUNT + 1))
          done
          
          if [ $COUNT -eq $TIMEOUT ]; then
            echo "Server failed to start within $TIMEOUT seconds"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          
          # 运行性能测试
          wrk -t4 -c100 -d10s --timeout 5s http://localhost:8080/
          WRK_EXIT=$?
          
          # 清理
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true
          
          if [ $WRK_EXIT -ne 0 ]; then
            echo "Performance test failed with exit code: $WRK_EXIT"
            exit 1
          fi
        else
          echo "performance_static_server not found, skipping performance test"
        fi

  # 代码质量检查只在 main 分支和 PR 中运行
  code-quality:
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential clang-tidy cppcheck lcov

    - name: Build project
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug
        cmake --build build --config Debug -j$(nproc)

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,performance,portability --error-exitcode=0 --suppress=missingIncludeSystem --suppress=unusedFunction --suppress=constParameter --suppress=unusedStructMember \
          -DUVHTTP_STRINGIFY\(x\)=\#x \
          -DUVHTTP_FEATURE_WEBSOCKET=1 \
          -DUVHTTP_FEATURE_STATIC_FILES=1 \
          -DUVHTTP_FEATURE_TLS=1 \
          -DUVHTTP_FEATURE_RATE_LIMIT=1 \
          -DUVHTTP_FEATURE_LOGGING=1 \
          -DUVHTTP_FEATURE_LRU_CACHE=1 \
          -DUVHTTP_FEATURE_ROUTER_CACHE=1 \
          -DUVHTTP_ENABLE_ROUTER_CACHE_OPTIMIZATION=1 \
          -DUVHTTP_ROUTER_SEARCH_MODE=2 \
          src/ || echo "cppcheck completed with warnings"

    - name: Memory leak check
      run: |
        cd build
        if [ -f "./dist/bin/test_connection_full_coverage" ]; then
          valgrind --leak-check=full --error-exitcode=0 ./dist/bin/test_connection_full_coverage || echo "Valgrind completed"
        else
          echo "test_connection_full_coverage not found, skipping valgrind"
        fi

  # 覆盖率测试只在 main 分支和 PR 中运行
  coverage:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential lcov

    - name: Build with coverage
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON
        cmake --build build --config Debug -j$(nproc)

    - name: Run all tests with coverage
      run: |
        cd build
        # 运行所有测试（包括快速测试和慢速测试）以生成完整覆盖率报告
        ctest --output-on-failure -j1 --timeout 1800 --schedule-random || {
          echo "Some tests failed, continuing with coverage report"
        }

    - name: Generate coverage report
      run: |
        cd build
        lcov --capture --directory . --output-file coverage.info 2>/dev/null || echo "No coverage data found"
        if [ -f coverage.info ]; then
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --remove coverage.info 'test/*' --output-file coverage.info
          lcov --remove coverage.info 'examples/*' --output-file coverage.info
          lcov --summary coverage.info
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./build/coverage.info
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true
