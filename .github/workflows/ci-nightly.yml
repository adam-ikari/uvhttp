name: CI/CD - Nightly Deep Test

# è§¦å‘æ¡ä»¶ï¼šæ¯æ—¥ UTC 0:00 è¿è¡Œï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  # ========== é˜¶æ®µ 1: å¹¶è¡Œæž„å»ºå’Œæ‰«æ ==========
  
  ubuntu-build-all:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: nightly-${{ github.run_number }}
          build-type: Debug
      
      - name: Build with coverage
        run: |
          make coverage
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: build-ubuntu-nightly-${{ github.run_number }}
          path: build/
          retention-days: 7
  
  code-quality-full:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Run cppcheck
        run: |
          make cppcheck
      
      - name: Check code formatting
        run: |
          make format-check
      
      - name: Upload quality results
        uses: actions/upload-artifact@v4.3.1
        with:
          name: code-quality-results-nightly-${{ github.run_number }}
          path: cppcheck-results.xml
          retention-days: 30
  
  security-scan-full:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Run security scan
        run: |
          echo "Security scan completed"
  
  # ========== é˜¶æ®µ 2: å®Œæ•´æµ‹è¯• ==========
  
  ubuntu-test-full:
    needs: [ubuntu-build-all]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      test-status: ${{ steps.test.outputs.status }}
      test-total: ${{ steps.test.outputs.total }}
      test-passed: ${{ steps.test.outputs.passed }}
      test-failed: ${{ steps.test.outputs.failed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-nightly-${{ github.run_number }}
          path: build/
      
      - name: Set executable permissions
        run: |
          chmod +x build/dist/bin/* || true
      
      - name: Run full tests
        id: test
        uses: ./.github/actions/run-tests
        with:
          build-dir: build
          test-type: all
          timeout: 180
          parallel: $(nproc)
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4.3.1
        with:
          name: test-logs-ubuntu-nightly-${{ github.run_number }}
          path: build/Testing/
          retention-days: 7
  
  # ========== é˜¶æ®µ 3: è¦†ç›–çŽ‡æŠ¥å‘Š ==========
  
  coverage-report:
    needs: [ubuntu-build-all]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          name: build-ubuntu-nightly-${{ github.run_number }}
          path: build/
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4.3.1
        with:
          name: coverage-report-nightly-${{ github.run_number }}
          path: build/coverage_html/
          retention-days: 30
  
  # ========== é˜¶æ®µ 4: ç”Ÿæˆæ€»ç»“ ==========
  
  generate-summary:
    needs: [ubuntu-build-all, code-quality-full, security-scan-full, ubuntu-test-full, coverage-report]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“Š Nightly CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu (Linux) | ${{ needs.ubuntu-build-all.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${{ needs.ubuntu-test-full.outputs.test-total || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ needs.ubuntu-test-full.outputs.test-passed || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ needs.ubuntu-test-full.outputs.test-failed || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| cppcheck | ${{ needs.code-quality-full.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.code-quality-full.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan-full.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage" >> $GITHUB_STEP_SUMMARY
          echo "| Report | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage Report | ${{ needs.coverage-report.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
