name: Security Issue Creator

# è§¦å‘æ¡ä»¶ï¼šå½“å®‰å…¨æ‰«æå·¥ä½œæµå®Œæˆæ—¶
on:
  workflow_run:
    workflows: ['CI/CD - Push Complete Validation', 'CI/CD - Nightly Deep Testing']
    types: [completed]
    branches: [main, develop]

jobs:
  create-security-issue:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      issues: write
      contents: read
      actions: read
    
    steps:
      - name: Download security scan artifacts
        uses: actions/download-artifact@v4.1.2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: artifacts/
      
      - name: Check for security issues
        id: check
        run: |
          echo "Checking for security issues..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨æ‰«æç»“æœ
          SECURITY_FOUND=false
          ISSUE_COUNT=0
          ISSUE_DETAILS=""
          
          # æ£€æŸ¥ cppcheck ç»“æœ
          if [ -f "artifacts/cppcheck-results-push-*/cppcheck-results.xml" ]; then
            CPPCHECK_FILE=$(find artifacts -name "cppcheck-results.xml" | head -1)
            if [ -f "$CPPCHECK_FILE" ]; then
              CPPCHECK_ISSUES=$(grep -c '<error' "$CPPCHECK_FILE" || echo 0)
              if [ "$CPPCHECK_ISSUES" -gt 0 ]; then
                SECURITY_FOUND=true
                ISSUE_COUNT=$((ISSUE_COUNT + CPPCHECK_ISSUES))
                ISSUE_DETAILS="$ISSUE_DETAILS\n\n### cppcheck Issues ($CPPCHECK_ISSUES)\n"
                
                # æå–å‰ 5 ä¸ªä¸¥é‡é”™è¯¯
                ISSUE_DETAILS="$ISSUE_DETAILS\n\`\`\`xml\n"
                ISSUE_DETAILS="$ISSUE_DETAILS$(grep '<error' "$CPPCHECK_FILE" | head -5)\n"
                ISSUE_DETAILS="$ISSUE_DETAILS\n\`\`\`"
              fi
            fi
          fi
          
          # æ£€æŸ¥ clang-tidy ç»“æœ
          if [ -f "artifacts/clang-tidy-results.txt" ]; then
            CLANG_ISSUES=$(grep -c 'warning:\|error:' artifacts/clang-tidy-results.txt || echo 0)
            if [ "$CLANG_ISSUES" -gt 0 ]; then
              SECURITY_FOUND=true
              ISSUE_COUNT=$((ISSUE_COUNT + CLANG_ISSUES))
              ISSUE_DETAILS="$ISSUE_DETAILS\n\n### clang-tidy Issues ($CLANG_ISSUES)\n"
              
              # æå–å‰ 5 ä¸ªä¸¥é‡é”™è¯¯
              ISSUE_DETAILS="$ISSUE_DETAILS\n\`\`\`\n"
              ISSUE_DETAILS="$ISSUE_DETAILS$(grep 'error:' artifacts/clang-tidy-results.txt | head -5)\n"
              ISSUE_DETAILS="$ISSUE_DETAILS\n\`\`\`"
            fi
          fi
          
          # æ£€æŸ¥ CodeQL ç»“æœ
          if [ -d "artifacts/codeql-results-*" ]; then
            CODEQL_DIR=$(find artifacts -type d -name "codeql-results-*" | head -1)
            if [ -d "$CODEQL_DIR" ]; then
              # CodeQL ç»“æœé€šå¸¸åœ¨ SARIF æ ¼å¼ä¸­
              SECURITY_FOUND=true
              ISSUE_DETAILS="$ISSUE_DETAILS\n\n### CodeQL Security Analysis\n"
              ISSUE_DETAILS="$ISSUE_DETAILS\nCodeQL analysis completed. Check the workflow run for detailed results."
            fi
          fi
          
          echo "security-found=$SECURITY_FOUND" >> $GITHUB_OUTPUT
          echo "issue-count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          echo "issue-details=$ISSUE_DETAILS" >> $GITHUB_OUTPUT
      
      - name: Create security issue
        if: steps.check.outputs.security-found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueCount = '${{ steps.check.outputs.issue-count }}';
            const issueDetails = '${{ steps.check.outputs.issue-details }}';
            const workflowRun = '${{ github.event.workflow_run.id }}';
            const branch = '${{ github.event.workflow_run.head_branch }}';
            const commit = '${{ github.event.workflow_run.head_sha }}';
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„å®‰å…¨ issueï¼ˆæœ€è¿‘ 7 å¤©å†…ï¼‰
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'automated'],
              since: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
            });
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒåˆ†æ”¯çš„ issue
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(`Security Issues Detected`) &&
              issue.body.includes(`Branch: ${branch}`)
            );
            
            if (existingIssue) {
              console.log('Security issue already exists for this branch. Skipping creation.');
              return;
            }
            
            const issueTitle = `ğŸ”’ Security Issues Detected - ${issueCount} issues found`;
            const issueBody = `
## Security Scan Results

**Branch:** \`${branch}\`
**Commit:** \`${commit}\`
**Workflow Run:** [#${workflowRun}](${context.payload.repository.html_url}/actions/runs/${workflowRun})
**Total Issues:** ${issueCount}

### Issue Details
${issueDetails}

### Next Steps

1. Review the security scan results in the workflow artifacts
2. Fix the identified security issues
3. Update this issue with the fix details
4. Close this issue once all issues are resolved

### Related Links

- [Workflow Run](${context.payload.repository.html_url}/actions/runs/${workflowRun})
- [Security Scan Artifacts](${context.payload.repository.html_url}/actions/runs/${workflowRun})

---
*This issue was automatically created by the Security Issue Creator workflow.*
            `.trim();
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['security', 'automated', 'bug'],
              assignees: context.payload.repository.owner.login
            });
            
            console.log('Security issue created successfully!');
      
      - name: Summary
        if: steps.check.outputs.security-found == 'true'
        run: |
          echo "### Security Issues Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Total Issues: ${{ steps.check.outputs.issue-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Issue Created: Yes" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
      
      - name: No security issues
        if: steps.check.outputs.security-found == 'false'
        run: |
          echo "### No Security Issues Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The security scan completed successfully with no issues detected." >> $GITHUB_STEP_SUMMARY