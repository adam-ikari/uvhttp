name: Nightly Build

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  nightly-build:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Get current date
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
      
      # Build Release
      - name: Build Release
        uses: ./.github/workflows/reusable/build.yml
        with:
          os: ubuntu-latest
          build-type: Release
          enable-examples: true
          cache-key: nightly-${{ steps.date.outputs.timestamp }}
      
      # Run all tests
      - name: Run fast tests
        uses: ./.github/workflows/reusable/test.yml
        with:
          os: ubuntu-latest
          build-type: Release
          test-type: fast
      
      - name: Run slow tests
        uses: ./.github/workflows/reusable/test.yml
        with:
          os: ubuntu-latest
          build-type: Release
          test-type: slow
          timeout: 180
      
      # Build with coverage
      - name: Build with coverage
        uses: ./.github/workflows/reusable/build.yml
        with:
          os: ubuntu-latest
          build-type: Debug
          enable-coverage: true
          cache-key: nightly-coverage-${{ steps.date.outputs.timestamp }}
      
      - name: Run coverage tests
        uses: ./.github/workflows/reusable/test.yml
        with:
          os: ubuntu-latest
          build-type: Debug
          test-type: coverage
          timeout: 1800
      
      - name: Generate coverage report
        run: |
          cd build-coverage
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --remove coverage.info 'test/*' --output-file coverage.info
          lcov --summary coverage.info
      
      # Security scan
      - name: Security scan
        uses: ./.github/workflows/reusable/security.yml
        with:
          scan-type: all
      
      # Performance test
      - name: Download build artifacts for performance test
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-latest-Release
          path: build-release

      - name: Performance test
        run: |
          mkdir -p build-release/public
          echo "<html><body><h1>Performance Test</h1></body></html>" > build-release/public/index.html
          cd build-release
          if [ -f "./dist/bin/performance_static_server" ]; then
            ./dist/bin/performance_static_server -d ./public -p 8080 > /tmp/server.log 2>&1 &
            SERVER_PID=$!
            sleep 3
            wrk -t4 -c100 -d30s --timeout 5s http://localhost:8080/
            kill $SERVER_PID 2>/dev/null || true
          fi
      
      # Memory leak check
      - name: Build with AddressSanitizer
        uses: ./.github/workflows/reusable/build.yml
        with:
          os: ubuntu-latest
          build-type: Debug
          sanitizer: address
          cache-key: nightly-asan-${{ steps.date.outputs.timestamp }}
      
      - name: Run memory tests
        uses: ./.github/workflows/reusable/test.yml
        with:
          os: ubuntu-latest
          build-type: Debug
          test-type: memory
          timeout: 120
      
      # Create nightly release
      - name: Create nightly release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly-${{ steps.date.outputs.timestamp }}
          name: Nightly Build - ${{ steps.date.outputs.date }}
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up old nightly releases
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 7
          delete_tag_pattern: nightly-
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}