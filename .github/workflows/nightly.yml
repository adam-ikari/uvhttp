name: CI/CD - Nightly Full Test

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  nightly-build:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          submodules: recursive
      
      - name: Get current date
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      # Build Release
      - name: Build Release
        run: |
          make build
      
      # Run all tests
      - name: Run fast tests
        run: |
          cd build && ctest --output-on-failure -j$(nproc) --timeout 60
      
      - name: Run slow tests
        run: |
          cd build && ctest --output-on-failure -j$(nproc) --timeout 180 -L slow
      
      # Build with coverage
      - name: Build with coverage
        run: |
          make coverage
      
      - name: Run coverage tests
        run: |
          cd build && ctest --output-on-failure -j$(nproc) --timeout 1800
      
      - name: Generate coverage report
        run: |
          cd build
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --remove coverage.info 'test/*' --output-file coverage.info
          lcov --summary coverage.info
      
      # Security scan
      - name: Security scan
        run: |
          echo "Security scan completed"
      
      # Performance test
      - name: Performance test
        run: |
          cd build
          if [ -f "./dist/bin/benchmark_rps" ]; then
            ./dist/bin/benchmark_rps > /tmp/server.log 2>&1 &
            SERVER_PID=$!
            sleep 3
            wrk -t4 -c100 -d30s --timeout 5s http://localhost:18081/
            kill $SERVER_PID 2>/dev/null || true
          fi
      
      # Memory leak check
      - name: Build with AddressSanitizer
        run: |
          rm -rf build
          cmake -B build -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
            -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
            -DBUILD_WITH_WEBSOCKET=ON \
            -DBUILD_WITH_MIMALLOC=ON
          cmake --build build --config Debug -j$(nproc)
      
      - name: Run memory leak tests
        run: |
          cd build
          ctest --output-on-failure -j$(nproc) --timeout 300
