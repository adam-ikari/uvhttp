name: Nightly Build

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 0:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  nightly-build:
    if: github.ref == 'refs/heads/main' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Get current date
      id: date
      run: |
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        echo "datetime=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential lcov wrk valgrind

    - name: Configure CMake (Release)
      run: |
        cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DBUILD_EXAMPLES=ON

    - name: Build (Release)
      run: |
        cmake --build build-release --config Release -j$(nproc)

    - name: Run fast tests
      id: fast-tests
      run: |
        cd build-release
        start_time=$(date +%s)
        ctest --output-on-failure -j1 --timeout 60 --label-regex "^fast$" --schedule-random || {
          echo "Fast tests failed"
          exit 1
        }
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        echo "duration=$duration" >> $GITHUB_OUTPUT
        echo "result=success" >> $GITHUB_OUTPUT

    - name: Run slow tests
      id: slow-tests
      run: |
        cd build-release
        start_time=$(date +%s)
        ctest --output-on-failure -j1 --timeout 1800 --label-regex "^slow$" --schedule-random || {
          echo "Slow tests failed"
          exit 1
        }
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        echo "duration=$duration" >> $GITHUB_OUTPUT
        echo "result=success" >> $GITHUB_OUTPUT

    - name: Configure CMake (Debug with Coverage)
      run: |
        cmake -B build-coverage -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON

    - name: Build (Debug with Coverage)
      run: |
        cmake --build build-coverage --config Debug -j$(nproc)

    - name: Run all tests with coverage
      id: coverage-tests
      run: |
        cd build-coverage
        start_time=$(date +%s)
        ctest --output-on-failure -j1 --timeout 1800 --schedule-random || {
          echo "Some tests failed, continuing with coverage report"
        }
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        echo "duration=$duration" >> $GITHUB_OUTPUT

    - name: Generate coverage report
      id: coverage
      run: |
        cd build-coverage
        lcov --capture --directory . --output-file coverage.info 2>/dev/null || echo "No coverage data"
        if [ -f coverage.info ]; then
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --remove coverage.info 'test/*' --output-file coverage.info
          lcov --remove coverage.info 'examples/*' --output-file coverage.info
          lcov --summary coverage.info > coverage-summary.txt
          lcov --list coverage.info > coverage-details.txt
          
          # æå–è¦†ç›–çŽ‡æ•°æ®
          lines_cov=$(grep "lines" coverage-summary.txt | awk '{print $2}' | tr -d '%')
          funcs_cov=$(grep "functions" coverage-summary.txt | awk '{print $2}' | tr -d '%' || echo 0)
          branches_cov=$(grep "branches" coverage-summary.txt | awk '{print $2}' | tr -d '%' || echo 0)
          
          echo "lines=$lines_cov" >> $GITHUB_OUTPUT
          echo "functions=$funcs_cov" >> $GITHUB_OUTPUT
          echo "branches=$branches_cov" >> $GITHUB_OUTPUT
        fi

    - name: Performance test
      id: performance
      run: |
        mkdir -p build-release/public
        echo "<html><body><h1>Performance Test</h1></body></html>" > build-release/public/index.html
        echo "Test file content" > build-release/public/test.txt
        echo "Large test file" > build-release/public/large.txt
        dd if=/dev/zero of=build-release/public/large.bin bs=1M count=10 2>/dev/null
        
        cd build-release
        if [ -f "./dist/bin/performance_static_server" ]; then
          ./dist/bin/performance_static_server -d ./public -p 8080 > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          
          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
          for i in {1..10}; do
            if curl -s http://localhost:8080/ > /dev/null 2>&1; then
              echo "Server started"
              break
            fi
            sleep 1
          done
          
          # ========== åŸºå‡†æ€§èƒ½æµ‹è¯• ==========
          echo "=== Baseline Performance Test ===" > /tmp/performance.log
          echo "Test 1: Low concurrency (10 connections, 10 seconds)" >> /tmp/performance.log
          wrk -t4 -c10 -d10s --timeout 5s http://localhost:8080/ >> /tmp/performance.log 2>&1
          echo "" >> /tmp/performance.log
          
          echo "Test 2: Medium concurrency (50 connections, 10 seconds)" >> /tmp/performance.log
          wrk -t4 -c50 -d10s --timeout 5s http://localhost:8080/ >> /tmp/performance.log 2>&1
          echo "" >> /tmp/performance.log
          
          echo "Test 3: High concurrency (100 connections, 10 seconds)" >> /tmp/performance.log
          wrk -t4 -c100 -d10s --timeout 5s http://localhost:8080/ >> /tmp/performance.log 2>&1
          echo "" >> /tmp/performance.log
          
          # ========== åŽ‹åŠ›æµ‹è¯• ==========
          echo "=== Stress Test ===" >> /tmp/performance.log
          echo "Test 4: Extreme concurrency (500 connections, 30 seconds)" >> /tmp/performance.log
          wrk -t8 -c500 -d30s --timeout 10s http://localhost:8080/ >> /tmp/performance.log 2>&1
          echo "" >> /tmp/performance.log
          
          echo "Test 5: Very high concurrency (1000 connections, 30 seconds)" >> /tmp/performance.log
          wrk -t8 -c1000 -d30s --timeout 10s http://localhost:8080/ >> /tmp/performance.log 2>&1
          echo "" >> /tmp/performance.log
          
          # ========== æŒç»­è´Ÿè½½æµ‹è¯• ==========
          echo "=== Sustained Load Test ===" >> /tmp/performance.log
          echo "Test 6: Sustained load (100 connections, 60 seconds)" >> /tmp/performance.log
          wrk -t4 -c100 -d60s --timeout 5s http://localhost:8080/ >> /tmp/performance.log 2>&1
          echo "" >> /tmp/performance.log
          
          # ========== æ–‡ä»¶ä¸‹è½½æµ‹è¯• ==========
          echo "=== File Download Test ===" >> /tmp/performance.log
          echo "Test 7: Small file download (100 connections, 10 seconds)" >> /tmp/performance.log
          wrk -t4 -c100 -d10s --timeout 5s http://localhost:8080/test.txt >> /tmp/performance.log 2>&1
          echo "" >> /tmp/performance.log
          
          echo "Test 8: Large file download (50 connections, 10 seconds)" >> /tmp/performance.log
          wrk -t4 -c50 -d10s --timeout 10s http://localhost:8080/large.bin >> /tmp/performance.log 2>&1
          echo "" >> /tmp/performance.log
          
          # æå–åŸºå‡†æ€§èƒ½æŒ‡æ ‡ï¼ˆTest 3: 100 connectionsï¼‰
          rps=$(grep -A 20 "Test 3" /tmp/performance.log | grep "Requests/sec" | tail -1 | awk '{print $2}')
          latency_avg=$(grep -A 20 "Test 3" /tmp/performance.log | grep "Latency" | tail -1 | awk '{print $2}')
          latency_p99=$(grep -A 20 "Test 3" /tmp/performance.log | grep "99%" | tail -1 | awk '{print $2}')
          
          # æå–åŽ‹åŠ›æµ‹è¯•æŒ‡æ ‡ï¼ˆTest 5: 1000 connectionsï¼‰
          stress_rps=$(grep -A 20 "Test 5" /tmp/performance.log | grep "Requests/sec" | tail -1 | awk '{print $2}')
          stress_latency_avg=$(grep -A 20 "Test 5" /tmp/performance.log | grep "Latency" | tail -1 | awk '{print $2}')
          stress_latency_p99=$(grep -A 20 "Test 5" /tmp/performance.log | grep "99%" | tail -1 | awk '{print $2}')
          
          echo "rps=$rps" >> $GITHUB_OUTPUT
          echo "latency_avg=$latency_avg" >> $GITHUB_OUTPUT
          echo "latency_p99=$latency_p99" >> $GITHUB_OUTPUT
          echo "stress_rps=$stress_rps" >> $GITHUB_OUTPUT
          echo "stress_latency_avg=$stress_latency_avg" >> $GITHUB_OUTPUT
          echo "stress_latency_p99=$stress_latency_p99" >> $GITHUB_OUTPUT
          
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true
        else
          echo "performance_static_server not found, skipping performance test"
          echo "rps=0" >> $GITHUB_OUTPUT
          echo "latency_avg=0" >> $GITHUB_OUTPUT
          echo "latency_p99=0" >> $GITHUB_OUTPUT
          echo "stress_rps=0" >> $GITHUB_OUTPUT
          echo "stress_latency_avg=0" >> $GITHUB_OUTPUT
          echo "stress_latency_p99=0" >> $GITHUB_OUTPUT
        fi
    - name: Memory leak check
      id: memory
      run: |
        cd build-release
        if [ -f "./dist/bin/test_connection_full_coverage" ]; then
          valgrind --leak-check=full --error-exitcode=0 --log-file=valgrind.log \
            ./dist/bin/test_connection_full_coverage || true
          
          # æ£€æŸ¥å†…å­˜æ³„æ¼
          leaks=$(grep "definitely lost:" valgrind.log | awk '{print $4}')
          echo "leaks=$leaks" >> $GITHUB_OUTPUT
        fi

    - name: Generate test report
      run: |
        cd build-release
        ctest --verbose --no-compress-output -T Test > test-report.txt 2>&1 || true
        
        # ç»Ÿè®¡æµ‹è¯•ç»“æžœ
        total=$(grep -c "Test #" test-report.txt 2>/dev/null || echo 0)
        passed=$(grep -c "Passed" test-report.txt 2>/dev/null || echo 0)
        failed=$(grep -c "Failed" test-report.txt 2>/dev/null || echo 0)
        
        echo "total_tests=$total" >> $GITHUB_ENV
        echo "passed_tests=$passed" >> $GITHUB_ENV
        echo "failed_tests=$failed" >> $GITHUB_ENV

    - name: Create nightly build archive
      run: |
        mkdir -p nightly-${{ steps.date.outputs.timestamp }}
        cd nightly-${{ steps.date.outputs.timestamp }}
        
        # å¤åˆ¶åº“æ–‡ä»¶
        mkdir -p lib include
        cp ../build-release/dist/lib/*.a lib/ 2>/dev/null || true
        cp -r ../include/*.h include/ 2>/dev/null || true
        
        # å¤åˆ¶ç¤ºä¾‹ç¨‹åº
        mkdir -p bin
        cp ../build-release/dist/bin/* bin/ 2>/dev/null || true
        
        # å¤åˆ¶æµ‹è¯•æŠ¥å‘Š
        cp ../build-release/test-report.txt . 2>/dev/null || true
        cp ../build-coverage/coverage-summary.txt . 2>/dev/null || true
        cp ../build-coverage/coverage-details.txt . 2>/dev/null || true
        cp ../build-release/performance.log . 2>/dev/null || true
        cp ../build-release/valgrind.log . 2>/dev/null || true
        
        # åˆ›å»º README
        cat > README.md << EOF
# UVHTTP Nightly Build

**Build Date**: ${{ steps.date.outputs.datetime }}
**Commit**: $(git rev-parse --short HEAD)
**Branch**: main

## Installation

1. Extract the archive
2. Copy headers to \`/usr/local/include/uvhttp/\`
3. Copy library to \`/usr/local/lib/\`
4. Run \`ldconfig\`

## Test Results

- **Total Tests**: ${{ env.total_tests }}
- **Passed**: ${{ env.passed_tests }}
- **Failed**: ${{ env.failed_tests }}

## Coverage

- **Lines**: ${{ steps.coverage.outputs.lines }}%
- **Functions**: ${{ steps.coverage.outputs.functions }}%
- **Branches**: ${{ steps.coverage.outputs.branches }}%

## Performance

### Baseline Performance (100 connections)
- **RPS**: ${{ steps.performance.outputs.rps }}
- **Avg Latency**: ${{ steps.performance.outputs.latency_avg }}
- **P99 Latency**: ${{ steps.performance.outputs.latency_p99 }}

### Stress Test (1000 connections)
- **RPS**: ${{ steps.performance.outputs.stress_rps }}
- **Avg Latency**: ${{ steps.performance.outputs.stress_latency_avg }}
- **P99 Latency**: ${{ steps.performance.outputs.stress_latency_p99 }}

### Test Scenarios
- **Test 1**: Low concurrency (10 connections, 10s)
- **Test 2**: Medium concurrency (50 connections, 10s)
- **Test 3**: High concurrency (100 connections, 10s)
- **Test 4**: Extreme concurrency (500 connections, 30s)
- **Test 5**: Very high concurrency (1000 connections, 30s)
- **Test 6**: Sustained load (100 connections, 60s)
- **Test 7**: Small file download (100 connections, 10s)
- **Test 8**: Large file download (50 connections, 10s)

## Build Information

- Build Type: Release
- Examples: Enabled
- Coverage: Enabled

## Notes

This is an automated nightly build and may contain unstable features.
For production use, please use the latest stable release.
EOF
        
        cd ..
        tar -czf uvhttp-nightly-${{ steps.date.outputs.timestamp }}.tar.gz nightly-${{ steps.date.outputs.timestamp }}

    - name: Generate detailed report
      run: |
        cat > NIGHTLY_REPORT.md << EOF
# Nightly Build Report - ${{ steps.date.outputs.date }}

## Build Information

- **Date**: ${{ steps.date.outputs.datetime }}
- **Commit**: $(git rev-parse --short HEAD)
- **Branch**: main
- **Build Number**: ${{ github.run_number }}
- **Run ID**: ${{ github.run_id }}

## Test Results

### Fast Tests
- **Status**: ${{ steps.fast-tests.outputs.result }}
- **Duration**: ${{ steps.fast-tests.outputs.duration }}s

### Slow Tests
- **Status**: ${{ steps.slow-tests.outputs.result }}
- **Duration**: ${{ steps.slow-tests.outputs.duration }}s

### Coverage Tests
- **Duration**: ${{ steps.coverage-tests.outputs.duration }}s

### Overall
- **Total Tests**: ${{ env.total_tests }}
- **Passed**: ${{ env.passed_tests }}
- **Failed**: ${{ env.failed_tests }}
- **Pass Rate**: $(python3 -c "print(f'{(${{ env.passed_tests }} / ${{ env.total_tests }} * 100):.2f}%' if ${{ env.total_tests }} > 0 else 'N/A')")

## Code Coverage

- **Lines**: ${{ steps.coverage.outputs.lines }}%
- **Functions**: ${{ steps.coverage.outputs.functions }}%
- **Branches**: ${{ steps.coverage.outputs.branches }}%

## Performance Metrics

### Baseline (100 connections)
- **Requests/sec**: ${{ steps.performance.outputs.rps }}
- **Average Latency**: ${{ steps.performance.outputs.latency_avg }}
- **P99 Latency**: ${{ steps.performance.outputs.latency_p99 }}

### Stress Test (1000 connections)
- **Requests/sec**: ${{ steps.performance.outputs.stress_rps }}
- **Average Latency**: ${{ steps.performance.outputs.stress_latency_avg }}
- **P99 Latency**: ${{ steps.performance.outputs.stress_latency_p99 }}

### Test Scenarios
- Test 1: Low concurrency (10 connections, 10s)
- Test 2: Medium concurrency (50 connections, 10s)
- Test 3: High concurrency (100 connections, 10s)
- Test 4: Extreme concurrency (500 connections, 30s)
- Test 5: Very high concurrency (1000 connections, 30s)
- Test 6: Sustained load (100 connections, 60s)
- Test 7: Small file download (100 connections, 10s)
- Test 8: Large file download (50 connections, 10s)

## Memory Check

- **Memory Leaks**: ${{ steps.memory.outputs.leaks }} bytes

## Recent Commits

\`\`\`
$(git log --since="1 day ago" --pretty=format:"%h - %s (%an, %ar)" || echo "No commits in the last 24 hours")
\`\`\`

## Build Artifacts

- **Archive**: [uvhttp-nightly-${{ steps.date.outputs.timestamp }}.tar.gz](https://github.com/${{ github.repository }}/releases/download/nightly-${{ steps.date.outputs.timestamp }}/uvhttp-nightly-${{ steps.date.outputs.timestamp }}.tar.gz)
- **Size**: $(du -h uvhttp-nightly-${{ steps.date.outputs.timestamp }}.tar.gz | cut -f1)

## Notes

This is an automated nightly build and may contain unstable features.
For production use, please use the latest stable release.

---

Generated by GitHub Actions
EOF

    - name: Upload nightly build artifact
      uses: actions/upload-artifact@v3
      with:
        name: uvhttp-nightly-${{ steps.date.outputs.timestamp }}
        path: uvhttp-nightly-${{ steps.date.outputs.timestamp }}.tar.gz
        retention-days: 7

    - name: Upload report artifact
      uses: actions/upload-artifact@v3
      with:
        name: nightly-report-${{ steps.date.outputs.timestamp }}
        path: NIGHTLY_REPORT.md
        retention-days: 7

    - name: Create nightly build release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly-${{ steps.date.outputs.timestamp }}
        name: Nightly Build - ${{ steps.date.outputs.date }}
        body_path: NIGHTLY_REPORT.md
        draft: false
        prerelease: true
        files: |
          uvhttp-nightly-${{ steps.date.outputs.timestamp }}.tar.gz
          NIGHTLY_REPORT.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up old nightly releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      with:
        keep_latest: 7
        delete_tag_pattern: nightly-
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create nightly build summary
      run: |
        echo "## ðŸš€ Nightly Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Date**: ${{ steps.date.outputs.datetime }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: $(git rev-parse --short HEAD)" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: main" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Tests**: ${{ env.total_tests }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Passed**: ${{ env.passed_tests }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Failed**: ${{ env.failed_tests }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Pass Rate**: $(python3 -c "print(f'{(${{ env.passed_tests }} / ${{ env.total_tests }} * 100):.2f}%' if ${{ env.total_tests }} > 0 else 'N/A')")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- **Lines**: ${{ steps.coverage.outputs.lines }}%" >> $GITHUB_STEP_SUMMARY
        echo "- **Functions**: ${{ steps.coverage.outputs.functions }}%" >> $GITHUB_STEP_SUMMARY
        echo "- **Branches**: ${{ steps.coverage.outputs.branches }}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš¡ Performance" >> $GITHUB_STEP_SUMMARY
        echo "- **RPS**: ${{ steps.performance.outputs.rps }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Avg Latency**: ${{ steps.performance.outputs.latency_avg }}" >> $GITHUB_STEP_SUMMARY
        echo "- **P99 Latency**: ${{ steps.performance.outputs.latency_p99 }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Download" >> $GITHUB_STEP_SUMMARY
        echo "[uvhttp-nightly-${{ steps.date.outputs.timestamp }}.tar.gz](https://github.com/${{ github.repository }}/releases/download/nightly-${{ steps.date.outputs.timestamp }}/uvhttp-nightly-${{ steps.date.outputs.timestamp }}.tar.gz)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Recent Commits" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        git log --since="1 day ago" --pretty=format:"%h - %s" || echo "No commits in the last 24 hours" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
