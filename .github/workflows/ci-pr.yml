name: CI/CD - PR Quick Validation

# Ëß¶ÂèëÊù°‰ª∂ÔºöPR ÊâìÂºÄ„ÄÅÂêåÊ≠•„ÄÅÈáçÊñ∞ÊâìÂºÄÂà∞ main Êàñ develop ÂàÜÊîØ
on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

# Âπ∂ÂèëÊéßÂà∂ÔºöÂèñÊ∂àÂêå‰∏Ä PR ÁöÑÊóßËøêË°å
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  # ÁéØÂ¢ÉÂèòÈáè
  IS_PR: true
  BUILD_TYPE: Release
  TEST_TYPE: fast

jobs:
  # ========== Âπ∂Ë°å‰ªªÂä°ÁªÑ ==========
  
  # ‰ªªÂä° 1: Ubuntu ÊûÑÂª∫
  ubuntu-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      build-dir: ${{ steps.build.outputs.build-dir }}
      build-status: ${{ steps.build.outputs.status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          os: ubuntu-latest
      
      - name: Cache dependencies
        uses: ./.github/actions/cache-deps
        with:
          cache-key: pr-${{ github.event.pull_request.number }}
          build-type: Release
      
      - name: Configure CMake
        id: configure
        run: |
          cmake -B build-pr -DCMAKE_BUILD_TYPE=Release -DBUILD_EXAMPLES=ON
          echo "build-dir=build-pr" >> $GITHUB_OUTPUT
      
      - name: Build
        id: build
        run: |
          cmake --build build-pr --config Release -j$(nproc)
          echo "build-dir=build-pr" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: Check for warnings
        run: |
          if cmake --build build-pr --config Release 2>&1 | grep -i "warning:"; then
            echo "Found compiler warnings!"
            exit 1
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-ubuntu-pr-${{ github.event.pull_request.number }}
          path: build-pr/dist/
          retention-days: 3
  
  # ‰ªªÂä° 2: ‰ª£Á†ÅË¥®ÈáèÊ£ÄÊü•
  code-quality-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cppcheck-issues: ${{ steps.cppcheck.outputs.issues }}
      clang-tidy-issues: ${{ steps.clang-tidy.outputs.issues }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck clang-tidy
      
      - name: Run cppcheck
        id: cppcheck
        run: |
          cppcheck --enable=warning,performance,portability \
            --error-exitcode=0 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=constParameter \
            --suppress=unusedStructMember \
            --xml \
            -DUVHTTP_FEATURE_WEBSOCKET=1 \
            -DUVHTTP_FEATURE_STATIC_FILES=1 \
            -DUVHTTP_FEATURE_TLS=1 \
            -DUVHTTP_FEATURE_RATE_LIMIT=1 \
            -DUVHTTP_FEATURE_LOGGING=1 \
            src/ 2> cppcheck.xml || true
          
          ISSUES=$(grep -c '<error' cppcheck.xml || echo 0)
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
      
      - name: Run clang-tidy
        id: clang-tidy
        run: |
          cmake -B build-tidy -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          cmake --build build-tidy --config Debug -j$(nproc) --target uvhttp
          
          find src -name '*.c' -exec clang-tidy {} -p build-tidy \; 2> clang-tidy.log || true
          
          ISSUES=$(grep -c 'warning:\|error:' clang-tidy.log || echo 0)
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
      
      - name: Upload code quality results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: code-quality-pr-${{ github.event.pull_request.number }}
          path: |
            cppcheck.xml
            clang-tidy.log
          retention-days: 7
  
  # ‰ªªÂä° 3: ‰æùËµñÊºèÊ¥ûÊâ´Êèè
  dependency-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      vulnerabilities: ${{ steps.scan.outputs.vulnerabilities }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Run dependency scan
        id: scan
        run: |
          # Ê£ÄÊü• .gitmodules ‰∏≠ÁöÑ‰æùËµñ
          echo "Checking submodules for vulnerabilities..."
          
          # ËøôÈáåÂèØ‰ª•ÈõÜÊàê trivy ÊàñÂÖ∂‰ªñ‰æùËµñÊâ´ÊèèÂ∑•ÂÖ∑
          # ÊöÇÊó∂ËæìÂá∫Âç†‰ΩçÁ¨¶
          echo "vulnerabilities=0" >> $GITHUB_OUTPUT
  
  # ========== ‰æùËµñ‰ªªÂä°ÁªÑ ==========
  
  # ‰ªªÂä° 4: Âø´ÈÄüÊµãËØï
  ubuntu-test-fast:
    needs: ubuntu-build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      test-status: ${{ steps.test.outputs.status }}
      test-total: ${{ steps.test.outputs.total }}
      test-passed: ${{ steps.test.outputs.passed }}
      test-failed: ${{ steps.test.outputs.failed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-pr-${{ github.event.pull_request.number }}
          path: build-pr
      
      - name: Run fast tests
        id: test
        run: |
          cd build-pr
          ctest --output-on-failure -j1 --timeout 60 --schedule-random
          
          # Ëé∑ÂèñÊµãËØïÁªìÊûú
          TOTAL=$(ctest -N | grep "Total Tests:" | awk '{print $3}' || echo "0")
          echo "status=success" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$TOTAL" >> $GITHUB_OUTPUT
          echo "failed=0" >> $GITHUB_OUTPUT
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-logs-pr-${{ github.event.pull_request.number }}
          path: |
            build-pr/Testing/
            build-pr/**/*.log
          retention-days: 3
  
  # ‰ªªÂä° 5: ÊÄßËÉΩÂõûÂΩíÊ£ÄÊµã
  performance-regression-check:
    needs: ubuntu-build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      has-regression: ${{ steps.check.outputs.has-regression }}
      has-improvement: ${{ steps.check.outputs.has-improvement }}
      performance-report: ${{ steps.check.outputs.report }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-ubuntu-pr-${{ github.event.pull_request.number }}
          path: build-pr
      
      - name: Install wrk
        run: |
          sudo apt-get update
          sudo apt-get install -y wrk
      
      - name: Run quick performance test
        id: perf-test
        run: |
          mkdir -p build-pr/public
          echo "<html><body><h1>Performance Test</h1></body></html>" > build-pr/public/index.html
          
          cd build-pr
          ./dist/bin/performance_static_server -d ./public -p 8080 > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          sleep 3
          
          # Âø´ÈÄüÊµãËØïÔºö3‰∏™Âú∫ÊôØÔºåÊØè‰∏™5Áßí
          wrk -t4 -c10 -d5s --timeout 5s http://localhost:8080/ > /tmp/performance.log 2>&1
          wrk -t4 -c50 -d5s --timeout 5s http://localhost:8080/ >> /tmp/performance.log 2>&1
          wrk -t4 -c100 -d5s --timeout 5s http://localhost:8080/ >> /tmp/performance.log 2>&1
          
          kill $SERVER_PID 2>/dev/null || true
          
          cp /tmp/performance.log ../performance-pr.log
          cp /tmp/server.log ../server-pr.log
      
      - name: Parse performance results
        id: parse
        run: |
          python3 << 'EOF'
          import json
          import re
          
          # ËØªÂèñÊÄßËÉΩÊó•Âøó
          with open('performance-pr.log', 'r') as f:
              log_content = f.read()
          
          # Ëß£Êûê wrk ËæìÂá∫
          def parse_wrk_output(text):
              match = re.search(r'(\d+)\s+requests in\s+([\d.]+)s', text)
              if not match:
                  return None
              
              requests = int(match.group(1))
              duration = float(match.group(2))
              rps = requests / duration
              
              return {'rps': rps}
          
          # ÊèêÂèñÁªìÊûú
          results = []
          for i in range(3):
              pattern = r'(\d+)\s+requests in\s+([\d.]+)s'
              matches = re.findall(pattern, log_content)
              if matches:
                  for match in matches:
                      requests = int(match[0])
                      duration = float(match[1])
                      rps = requests / duration
                      results.append({'rps': rps})
          
          # ÁîüÊàê JSON
          output = {
              'test_scenarios': [
                  {'name': 'low_concurrent', 'results': {'rps': {'value': results[0]['rps'] if len(results) > 0 else 0}}},
                  {'name': 'medium_concurrent', 'results': {'rps': {'value': results[1]['rps'] if len(results) > 1 else 0}}},
                  {'name': 'high_concurrent', 'results': {'rps': {'value': results[2]['rps'] if len(results) > 2 else 0}}}
              ]
          }
          
          with open('performance-pr.json', 'w') as f:
              json.dump(output, f, indent=2)
          
          print(f"rps_low={output['test_scenarios'][0]['results']['rps']['value']:.0f}")
          print(f"rps_medium={output['test_scenarios'][1]['results']['rps']['value']:.0f}")
          print(f"rps_high={output['test_scenarios'][2]['results']['rps']['value']:.0f}")
          EOF
      
      - name: Check performance regression
        id: check
        run: |
          # ‰∏ãËΩΩÂü∫Á∫øÊñá‰ª∂
          BASELINE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/docs/performance/baseline.json"
          
          # Â∞ùËØï‰∏ãËΩΩÂü∫Á∫øÊñá‰ª∂
          if curl -f -s $BASELINE_URL -o baseline.json; then
            echo "Baseline file downloaded successfully"
          else
            echo "Baseline file not found or download failed, skipping regression check"
            echo "{}" > baseline.json
          fi
          
          # Ê£ÄÊü•Âü∫Á∫øÊñá‰ª∂ÊòØÂê¶ÊúâÊïà
          if [ ! -s baseline.json ] || [ "$(cat baseline.json | wc -l)" -lt 2 ]; then
            echo "Baseline file is empty or invalid, skipping regression check"
            echo "has-regression=false" >> $GITHUB_OUTPUT
            echo "has-improvement=false" >> $GITHUB_OUTPUT
            echo "# Performance Report" > performance-report.md
            echo "Baseline file not found or invalid, skipping regression check" >> performance-report.md
            echo "report=$(cat performance-report.md)" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ËøêË°åÂõûÂΩíÊ£ÄÊµãËÑöÊú¨
          if [ -f "scripts/performance_regression.py" ]; then
            python3 scripts/performance_regression.py performance-pr.json baseline.json --fail-on-regression > performance-report.md 2>&1
            REGRESSION_EXIT=$?
            
            # Ëß£ÊûêËÑöÊú¨ËøîÂõûÂÄº
            if [ $REGRESSION_EXIT -eq 1 ]; then
              # ÊÄßËÉΩÂõûÂΩíÊàñÈîôËØØ
              echo "has-regression=true" >> $GITHUB_OUTPUT
              echo "has-improvement=false" >> $GITHUB_OUTPUT
              echo "report=$(cat performance-report.md)" >> $GITHUB_OUTPUT
              exit 1  # ÈòªÊ≠¢ workflow
            else
              # Êó†ÂõûÂΩíÔºàÂåÖÊã¨ÊÄßËÉΩÊîπËøõÊàñÊó†ÊòæËëóÂèòÂåñÔºâ
              echo "has-regression=false" >> $GITHUB_OUTPUT
              echo "has-improvement=true" >> $GITHUB_OUTPUT
              echo "report=$(cat performance-report.md)" >> $GITHUB_OUTPUT
            fi
          else
            echo "Performance regression script not found"
            echo "has-regression=false" >> $GITHUB_OUTPUT
            echo "has-improvement=false" >> $GITHUB_OUTPUT
            echo "# Performance Report" > performance-report.md
            echo "Performance regression script not found" >> performance-report.md
            echo "report=$(cat performance-report.md)" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: performance-comparison-pr-${{ github.event.pull_request.number }}
          path: |
            performance-pr.json
            performance-pr.log
            server-pr.log
            performance-report.md
          retention-days: 7
  
  # ========== Ê±áÊÄª‰ªªÂä°ÁªÑ ==========
  
  # ‰ªªÂä° 6: ÁîüÊàê PR ÊëòË¶Å
  generate-pr-summary:
    needs: [ubuntu-build, code-quality-check, dependency-scan, ubuntu-test-fast, performance-regression-check]
    runs-on: ubuntu-latest
    timeout-minutes: 2
    if: always()
    
    steps:
      - name: Generate PR summary
        run: |
          echo "## üìä PR CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Ubuntu Build: ${{ needs.ubuntu-build.outputs.build-status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Total: ${{ needs.ubuntu-test-fast.outputs.test-total }}" >> $GITHUB_STEP_SUMMARY
          echo "- Passed: ${{ needs.ubuntu-test-fast.outputs.test-passed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: ${{ needs.ubuntu-test-fast.outputs.test-failed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "- cppcheck issues: ${{ needs.code-quality-check.outputs.cppcheck-issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- clang-tidy issues: ${{ needs.code-quality-check.outputs.clang-tidy-issues }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance" >> $GITHUB_STEP_SUMMARY
          echo "- Regression: ${{ needs.performance-regression-check.outputs.has-regression == 'true' && '‚ùå Detected' || '‚úÖ None' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Improvement: ${{ needs.performance-regression-check.outputs.has-improvement == 'true' && '‚úÖ Detected' || '‚ûñ None' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerabilities: ${{ needs.dependency-scan.outputs.vulnerabilities }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## üìä PR CI/CD Summary
            
            ### Build Status
            - Ubuntu Build: ${{ needs.ubuntu-build.outputs.build-status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}
            
            ### Test Results
            - Total: ${{ needs.ubuntu-test-fast.outputs.test-total }}
            - Passed: ${{ needs.ubuntu-test-fast.outputs.test-passed }}
            - Failed: ${{ needs.ubuntu-test-fast.outputs.test-failed }}
            
            ### Code Quality
            - cppcheck issues: ${{ needs.code-quality-check.outputs.cppcheck-issues }}
            - clang-tidy issues: ${{ needs.code-quality-check.outputs.clang-tidy-issues }}
            
            ### Performance
            - Regression: ${{ needs.performance-regression-check.outputs.has-regression == 'true' && '‚ùå Detected' || '‚úÖ None' }}
            - Improvement: ${{ needs.performance-regression-check.outputs.has-improvement == 'true' && '‚úÖ Detected' || '‚ûñ None' }}
            
            ### Dependencies
            - Vulnerabilities: ${{ needs.dependency-scan.outputs.vulnerabilities }}
            
            ---
            *This comment is automatically generated by GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });