name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  ai-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Rate limiting: Only run once per hour per repository
    concurrency:
      group: ai-review-${{ github.repository }}-${{ github.head_ref }}
      cancel-in-progress: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v42
      with:
        files: |
          **/*.c
          **/*.h
          **/*.cpp
          **/*.hpp
          **/*.cc
          **/*.cxx
          **/*.m
          **/*.mm

    - name: AI Code Review
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: github/github-ai-review-action@v1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        model: gpt-4o
        max-tokens: 4000
        temperature: 0.3
        system-prompt: |
          You are an expert C code reviewer. Review the code changes for:
          1. Code quality and style
          2. Potential bugs and issues
          3. Security vulnerabilities
          4. Performance optimizations
          5. Best practices adherence
          6. Memory management issues
          7. Error handling

          Provide specific, actionable feedback with code examples where appropriate.
          Be constructive and helpful.

    - name: Generate Review Summary
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        set -e  # Exit on error

        # Create review summary file
        cat > review_summary.md << 'EOF'
        ## AI Code Review Summary

        ### Changed Files
        ${{ steps.changed-files.outputs.all_changed_files }}

        ### Review Date
        $(date -u +'%Y-%m-%d %H:%M:%S UTC')

        ### Reviewer
        GitHub AI (GPT-4o)
        EOF

        echo "Review summary created successfully"

    - name: Post Review Comment
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          if (!fs.existsSync('review_summary.md')) {
            console.error('Error: review_summary.md not found');
            core.setFailed('Review summary file not found');
            return;
          }

          try {
            const summary = fs.readFileSync('review_summary.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

            console.log('Review comment posted successfully');
          } catch (error) {
            console.error('Error posting review comment:', error);
            core.setFailed(`Failed to post review comment: ${error.message}`);
          }

    - name: Check for Critical Issues
      id: critical-check
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        set -e  # Exit on error

        # Check if review summary file exists
        if [ ! -f "review_summary.md" ]; then
          echo "Error: review_summary.md not found"
          echo "CRITICAL_ISSUES_FOUND=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Check for critical issues in the review summary
        if grep -qi "critical\|security\|memory leak\|buffer overflow" review_summary.md 2>/dev/null; then
          echo "CRITICAL_ISSUES_FOUND=true" >> $GITHUB_OUTPUT
          echo "Found critical issues in review"
        else
          echo "CRITICAL_ISSUES_FOUND=false" >> $GITHUB_OUTPUT
          echo "No critical issues found"
        fi

    - name: Alert on Critical Issues
      if: steps.changed-files.outputs.any_changed == 'true' && steps.critical-check.outputs.CRITICAL_ISSUES_FOUND == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          if (!fs.existsSync('review_summary.md')) {
            console.error('Error: review_summary.md not found');
            return;
          }

          try {
            const review = fs.readFileSync('review_summary.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Critical Issues Found in PR #${context.issue.number}`,
              body: `AI Code Review found critical issues in PR #${context.issue.number}.\n\n${review}`,
              labels: ['critical', 'security', 'ai-review']
            });

            console.log('Critical issue alert created successfully');
          } catch (error) {
            console.error('Error creating critical issue alert:', error);
            core.setFailed(`Failed to create critical issue alert: ${error.message}`);
          }

    - name: Cleanup
      if: always()
      run: |
        # Clean up temporary files
        rm -f review_summary.md
        echo "Cleanup completed"